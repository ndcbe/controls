
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>6.8. TCLab: Open-Loop Optimization and Estimation using Pyomo &#8212; CBE 30338 Data Analytics, Optimization, and Control</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=9c3e77be" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=1ae7504c"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/6/TCLab-Optimization-Estimation-Control';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="6.9. TCLab: Model Predictive Control (MPC)" href="TCLab-Model-Predictive-Control.html" />
    <link rel="prev" title="6.7. Time as a Decision Variable" href="time-as-decision-variable.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../Readme.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo.png" class="logo__image only-light" alt="CBE 30338 Data Analytics, Optimization, and Control - Home"/>
    <script>document.write(`<img src="../../_static/logo.png" class="logo__image only-dark" alt="CBE 30338 Data Analytics, Optimization, and Control - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../Readme.html">
                    CBE 30338 Data Analytics, Optimization, and Control
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Course Information</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../Syllabus.html">Syllabus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Schedule.html">Schedule</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../assignments/assignments.html">Assignments</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../assignments/Homework-1.html">Homework 1: Computing and Data Analysis Review</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../assignments/Lab-1-Step-Testing.html">Lab 1: Step Test of a First-Order System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../assignments/Lab-2-Model-Identification.html">Lab 2: Model Identification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../assignments/Lab-3-Relay-Control.html">Lab 3: Relay (On-Off) Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../assignments/Lab-4-PI-Control.html">Lab 4: PI Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../assignments/Homework-2.html">Homework 2: Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../assignments/Lab-5-Open-Loop-Optimization.html">Lab 5: Open Loop Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../assignments/Lab-6-MPC.html">Lab 6: Model Predictive Control (MPC)</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Topical Materials</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../1/What-is-Process-Control.html">1. What is Process Control?</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../1/What-is-Feedback.html">1.1. What is Feedback?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../1/Elements-of-Feedback-Control.html">1.2. Elements of Process Control</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../2/Process-Modeling.html">2. Process Modeling</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../2/One-Compartment-Pharmacokinetics.html">2.1. One Compartment Pharmacokinetics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../2/Properties-of-Scalar-First-Order-Linear-Systems.html">2.2. First-Order Linear Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../2/First-Order-Model-for-a-Single-Heater.html">2.3. First Order Model for a Single Heater</a></li>
<li class="toctree-l2"><a class="reference internal" href="../2/Fitting-a-Model-to-Data.html">2.4. Fitting a Model to Experimental Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../2/Second-Order.html">2.5. Second Order Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../2/Fed-Batch-Bioreactor.html">2.6. Fed-Batch Bioreactor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../2/Spring-Mass-Damper.html">2.7. Characteristics of Second Order Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../2/Exothermic-CSTR.html">2.8. Application: Exothermic Continuous Stirred Tank Reactor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../2/Hare-and-Lynx.html">2.9. Hare and Lynx Population Dynamics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../2/Study-Guide.html">2.10. Study Guide</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../3/Feedback-Control.html">3. Feedback Control</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../3/Case-Study-Thermal-Cycling-PCR.html">3.1. Case Study: Thermal Cycling for PCR</a></li>
<li class="toctree-l2"><a class="reference internal" href="../3/Setpoints.html">3.2. Setpoints</a></li>
<li class="toctree-l2"><a class="reference internal" href="../3/Setpoints-Thermal-Cycler.html">3.3. Case Study: PCR Thermal Cycler Protocols</a></li>
<li class="toctree-l2"><a class="reference internal" href="../3/Relay-Control.html">3.4. Relay Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../3/Implementing-Controllers.html">3.5. Implementing Controllers in Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="../3/Proportional-Integral-Control.html">3.6. Practical Proportional (P) and Proportional-Integral (PI) Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../3/P-Controller-Analysis.html">3.7. Analysis of Proportional Only Controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="../3/PI-Controller-Analysis.html">3.8. Analysis of Proportional-Integral Controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="../3/Integral-Windup-and-Bumpless-Transfer.html">3.9. Integral Windup and Bumpless Transfer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../3/Bumpless-PI-Controller-Analysis.html">3.10. Analysis of Velocity-Form Bumpless PI Controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="../3/Controller-Tuning.html">3.11. Controller Tuning</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../4/Process-Analytics.html">4. Process Analytics</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../4/Learning-Goals.html">4.1. Learning Goals</a></li>
<li class="toctree-l2"><a class="reference internal" href="../4/Process-Historians.html">4.2. Data/Process/Operational Historian</a></li>
<li class="toctree-l2"><a class="reference internal" href="../4/State-Estimation.html">4.3. State Estimation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../4/Lab-Assigment-State-Estimation.html">4.4. Lab Assignment 5: State Estimation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../4/Anomaly-Detection.html">4.5. Anomaly Detection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../4/Lab-Assignment-Anomaly-Detection.html">4.6. Lab Assignment 6: Anomaly Detection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../4/Observer-Synthesis-LMI.html">4.7. Observer Synthesis using Linear Matrix Inequalities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../4/Envrironmental-Application.html">4.8. Application of Luenberger Observers to Environmental Modeling of Rivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../4/Study-Questions.html">4.9. Study Questions</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../5/Optimization.html">5. Optimization</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../5/Linear-Production-Model.html">5.1. Linear Production Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../5/Linear-Blending-Problem.html">5.2. Linear Blending Problems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../5/Homework_2.html">5.3. Homework 2: Optimization (Legacy)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../5/Gasoline-Blending.html">5.4. Gasoline Blending</a></li>
<li class="toctree-l2"><a class="reference internal" href="../5/Linear-Programming.html">5.5. Linear Programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="../5/Design-of-a-Cold-Weather-Fuel.html">5.6. Design of a Cold Weather Fuel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../5/Pyomo-Examples.html">5.7. Pyomo Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../5/EV-Example.html">5.8. Recharging Strategy for an Electric Vehicle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../5/milk-pooling.html">5.9. Pooling and Blending</a></li>
</ul>
</details></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="Predictive-Control-Chapter.html">6. Predictive Control</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="Static-Operability.html">6.1. Static Operability</a></li>
<li class="toctree-l2"><a class="reference internal" href="Simulation-and-Open-Loop-Optimal-Control.html">6.2. Open-Loop Optimal Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="Predictive-Control.html">6.3. Predictive Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="Implementing-Predictive-Control.html">6.4. Implementing Predictive Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="gompertz-tumor-growth.html">6.5. Gompertz Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="gompertz-model-project.html">6.6. Project: Gompertz Model for Tumor Growth</a></li>
<li class="toctree-l2"><a class="reference internal" href="time-as-decision-variable.html">6.7. Time as a Decision Variable</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">6.8. TCLab: Open-Loop Optimization and Estimation using Pyomo</a></li>
<li class="toctree-l2"><a class="reference internal" href="TCLab-Model-Predictive-Control.html">6.9. TCLab: Model Predictive Control (MPC)</a></li>
<li class="toctree-l2"><a class="reference internal" href="Simulation-and-Optimal-Control-in-Pharmacokinetics.html">6.10. Simulation and Optimal Control in Pharmacokinetics</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../08.00-Projects.html">7. Projects (Spring 2023)</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../08.01-Project-Ideas.html">7.1. Project Ideas</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../09.00-Bibliography.html">8. References</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Control Laboratory</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../tclab/00.00-tclab.html">1. The Temperature Control Laboratory</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tclab/00.01-setting-up-tclab.html">1.1. Setting up TCLab</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tclab/00.02-troubleshooting-tclab.html">1.2. Testing and Troubleshooting TCLab</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tclab/00.03-using-tclab.html">1.3. Python Coding for TCLab</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tclab/testing-software-environment.html">1.4. Testing Your Software Environment and TCLab</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../tclab/01.00-step-testing.html">2. Step Testing</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tclab/01.01-step-testing.html">2.1. Step Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tclab/01.02-first-order-model-for-a-single-heater.html">2.2. Lab Assignment 1: Step Test of a First-Order System</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../tclab/02.00-Empirical-Model-Identification.html">3. Empirical Model Identification</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tclab/02.02-Fitting-Step-Test-Data-to-Empirical-Models.html">3.1. Fitting Step Test Data to Empirical Models</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../tclab/03.00-Estimating-Model-Parameters.html">4. Estimating Model Parameters</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tclab/03.04-Two-Input-Two-Output-Model.html">4.1. Two-Input, Two-Output Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tclab/03.05-Two-State-Model-for-a-Single-Heater.html">4.2. Two State Model for a Single Heater</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tclab/03.06-Four-State-Model.html">4.3. Four State Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tclab/03.10-TCLab-Lab-2-Model-Indentification.html">4.4. Assignment: Model Identification</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../tclab/04.00-Feedback-Control.html">5. Feedback Control</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tclab/04.01-Relay-Control.html">5.1. Relay Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tclab/04.02-Lab-Assignment-Relay-Control.html">5.2. Lab Assignment 4: Relay Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tclab/04.10-Lab-Assignment-PID-Control.html">5.3. Lab Assignment: PID Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tclab/04.11-Lab-Assignment-PI-Control.html">5.4. Lab Assignment 4: PI Control</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../tclab/05.00-State-Estimation.html">6. State Estimation</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tclab/05.01-Open-and-Closed-Loop-Estimation.html">6.2. Open and Closed Loop Estimation</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../../tclab/06.00-Optimal-Control.html">7. Optimization</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../tclab/07.00-Predictive-Control-and-Real-Time-Optimization.html">8. Predictive Control and Real Time Optimization</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tclab/07.01-Optimization-Control-and-Estimation-using-Pyomo.html">8.1. Simulation, Control, and Estimation using Pyomo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tclab/07.02-Optimization-Control-and-Estimation-using-Pyomo-With-Windows-ipopt.html">8.2. Simulation, Control, and Estimation using Pyomo</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Python Tutorials</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../python/A.00-Python-Tutorials.html">Python Tutorials</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../python/A.05-Tidy-Data-and-Pandas.html">Tidy Data and Pandas</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../python/A.10-Coding-Controllers-with-Python-Generators.html">Coding Controllers with Python Generators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../python/A.11-Modular-Approach-to-Simulation-using-Python-Generators.html">Modular Simulation using Python Generators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../python/A.30-Animation-in-Jupyter-Notebooks.html">Animation in Jupyter Notebooks</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/ndcbe/controls/blob/main/notebooks/6/TCLab-Optimization-Estimation-Control.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/ndcbe/controls" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/ndcbe/controls/issues/new?title=Issue%20on%20page%20%2Fnotebooks/6/TCLab-Optimization-Estimation-Control.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/notebooks/6/TCLab-Optimization-Estimation-Control.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>TCLab: Open-Loop Optimization and Estimation using Pyomo</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-objectives">6.8.1. Learning Objectives</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mathematical-model-and-pyomo-simulation">6.8.2. Mathematical Model and Pyomo Simulation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pyomo-model">6.8.2.1. Pyomo Model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#process-inputs">6.8.2.2. Process Inputs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#optimal-control-with-knowledge-of-disturbances">6.8.3. Optimal Control with Knowledge of Disturbances</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#hardware-implementation">6.8.4. Hardware Implementation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#estimation-observation">6.8.5. Estimation/Observation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#small-objective-weight-w-0-01">6.8.5.1. Small Objective Weight (<span class="math notranslate nohighlight">\(w=0.01\)</span>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#medium-objective-weight-w-0-1">6.8.5.2. Medium Objective Weight (<span class="math notranslate nohighlight">\(w=0.1\)</span>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#medium-large-objective-weight-w-1">6.8.5.3. Medium Large Objective Weight (<span class="math notranslate nohighlight">\(w=1\)</span>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extra-large-objective-weight-w-10">6.8.5.4. Extra Large Objective Weight (<span class="math notranslate nohighlight">\(w=10\)</span>)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#parameter-estimation">6.8.6. Parameter Estimation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assume-no-disturbance">6.8.6.1. Assume no disturbance</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recommended-exercise-take-two">6.8.7. Recommended Exercise: Take Two</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#open-loop-optimization">6.8.7.1. Open-Loop Optimization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implement-on-hardware-simulation">6.8.7.2. Implement on Hardware (Simulation)</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="tclab-open-loop-optimization-and-estimation-using-pyomo">
<h1><span class="section-number">6.8. </span>TCLab: Open-Loop Optimization and Estimation using Pyomo<a class="headerlink" href="#tclab-open-loop-optimization-and-estimation-using-pyomo" title="Link to this heading">#</a></h1>
<section id="learning-objectives">
<h2><span class="section-number">6.8.1. </span>Learning Objectives<a class="headerlink" href="#learning-objectives" title="Link to this heading">#</a></h2>
<ol class="arabic simple">
<li><p>Compute optimal heater strategy using physics-based model</p></li>
<li><p>Verify open loop performance with TC Lab simulation</p></li>
<li><p>Estimate unmeasured states (heater temperature) using model</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="k">if</span> <span class="s2">&quot;google.colab&quot;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
    <span class="o">!</span>wget<span class="w"> </span><span class="s2">&quot;https://raw.githubusercontent.com/IDAES/idaes-pse/main/scripts/colab_helper.py&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">colab_helper</span>
    <span class="n">colab_helper</span><span class="o">.</span><span class="n">install_idaes</span><span class="p">()</span>
    <span class="n">colab_helper</span><span class="o">.</span><span class="n">install_ipopt</span><span class="p">()</span>
    <span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>tclab

<span class="c1"># Set default parameters for publication quality plots</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="n">SMALL_SIZE</span> <span class="o">=</span> <span class="mi">14</span>
<span class="n">MEDIUM_SIZE</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">BIGGER_SIZE</span> <span class="o">=</span> <span class="mi">18</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">SMALL_SIZE</span><span class="p">)</span>  <span class="c1"># controls default text sizes</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;axes&#39;</span><span class="p">,</span> <span class="n">titlesize</span><span class="o">=</span><span class="n">SMALL_SIZE</span><span class="p">)</span>  <span class="c1"># fontsize of the axes title</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;axes&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">MEDIUM_SIZE</span><span class="p">)</span>  <span class="c1"># fontsize of the x and y labels</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;xtick&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">SMALL_SIZE</span><span class="p">)</span>  <span class="c1"># fontsize of the tick labels</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;ytick&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">SMALL_SIZE</span><span class="p">)</span>  <span class="c1"># fontsize of the tick labels</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;legend&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">SMALL_SIZE</span><span class="p">)</span>  <span class="c1"># legend fontsize</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;figure&#39;</span><span class="p">,</span> <span class="n">titlesize</span><span class="o">=</span><span class="n">BIGGER_SIZE</span><span class="p">)</span>  <span class="c1"># fontsize of the figure title</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="mathematical-model-and-pyomo-simulation">
<h2><span class="section-number">6.8.2. </span>Mathematical Model and Pyomo Simulation<a class="headerlink" href="#mathematical-model-and-pyomo-simulation" title="Link to this heading">#</a></h2>
<p>Recall the two-state model for a single heater/sensor assembly:</p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
C_p^H \frac{dT_H}{dt} &amp; = U_a (T_{amb} - T_H) + U_b (T_S - T_H) + \alpha P u(t) + d(t)\\
C_p^S \frac{dT_S}{dt} &amp; = - U_b (T_S - T_H) 
\end{align*}\]</div>
<section id="pyomo-model">
<h3><span class="section-number">6.8.2.1. </span>Pyomo Model<a class="headerlink" href="#pyomo-model" title="Link to this heading">#</a></h3>
<p>The code block below provides a library for performing several analysis tasks with our model. This is a <code class="docutils literal notranslate"><span class="pre">class</span></code>, which is a more sophisticated way to modularize our code. Briefly, classes store both data and methods to manipualte the data.</p>
<p>Take a few minutes to study this code. Note the missing lines of code to fill in when you get to Exercise 1. A few features:</p>
<ul class="simple">
<li><p>It supports four modes:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">simulate</span></code>: solve the model with all of the inputs specified (zero degrees of freedom)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">optimize</span></code>: determine the best <span class="math notranslate nohighlight">\(u(t)\)</span> to track the desired <span class="math notranslate nohighlight">\(T_{set}(t)\)</span></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">observe</span></code>: estimate the unmeasured state <span class="math notranslate nohighlight">\(T_{H}(t)\)</span> and disturbance <span class="math notranslate nohighlight">\(d(t)\)</span> from experimental data</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">estimate</span></code>: estimate the model parameters <span class="math notranslate nohighlight">\(U_a\)</span>, <span class="math notranslate nohighlight">\(U_b\)</span>, <span class="math notranslate nohighlight">\(C_p^H\)</span>, <span class="math notranslate nohighlight">\(C_p^S\)</span> from experimental data</p></li>
</ul>
</li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method is called automatically when you create an instance of the object. The initial method is how you pass in data</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">solve</span></code> method call the numerical optimization algorithm</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">plot</span></code> method plots the Pyomo results</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">get_Ts</span></code>, <code class="docutils literal notranslate"><span class="pre">get_Th</span></code>, <code class="docutils literal notranslate"><span class="pre">get_U</span></code>, and <code class="docutils literal notranslate"><span class="pre">get_D</span></code> methods return data stored in the Pyomo model after it is solved</p></li>
</ul>
<p>This notebook walks you through using the library. The take away message is that a class is a convient way to modularize our code and maximize reuse. The four supported modes are very similar.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">interpolate</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># ensure that IDAES is imported if there is an error calling Ipopt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">idaes</span>

<span class="c1"># Protip: only import the functions you need for each library.</span>
<span class="c1"># This tells other programs exactly where each function is defined.</span>
<span class="c1"># Avoid using from pyomo.environ import * as this imports everything</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyomo.environ</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConcreteModel</span><span class="p">,</span> <span class="n">Var</span><span class="p">,</span> <span class="n">Param</span><span class="p">,</span> <span class="n">Constraint</span><span class="p">,</span> <span class="n">TransformationFactory</span><span class="p">,</span> <span class="n">SolverFactory</span><span class="p">,</span> <span class="n">Objective</span><span class="p">,</span> <span class="n">minimize</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">Suffix</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyomo.dae</span><span class="w"> </span><span class="kn">import</span> <span class="n">DerivativeVar</span><span class="p">,</span> <span class="n">ContinuousSet</span><span class="p">,</span> <span class="n">Simulator</span>

<span class="c1">##### IMPORTANT #####</span>
<span class="c1"># When you do Lab 5, you need to update Ua, Ub, CpH, and CpS to the values</span>
<span class="c1"># you previously estimated for your hardware.</span>
<span class="c1">#</span>
<span class="c1">#####################</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TCLabPyomo</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This class contains the methods used for simulating the TCLab model, optimizing u(t) per a </span>
<span class="sd">    given set point for T, observing a disturbance, and estimating model parameters in the TCLab.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">t_data</span><span class="p">,</span> <span class="n">u_data</span><span class="p">,</span> <span class="n">d_data</span><span class="p">,</span> <span class="n">Tset_data</span><span class="p">,</span> 
                 <span class="n">TS_data</span><span class="p">,</span> <span class="n">Tamb</span> <span class="o">=</span> <span class="mf">21.0</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.00016</span><span class="p">,</span> <span class="n">P1</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
                 <span class="n">Ua</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">Ub</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">CpH</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span> <span class="n">CpS</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                 <span class="n">integrate_to_initialize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">obj_weight</span><span class="o">=</span><span class="mf">0.1</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Method called automatically when instantiating class.</span>
<span class="sd">        Arguments:</span>
<span class="sd">            mode: specify mode</span>
<span class="sd">            t_data: time data</span>
<span class="sd">            u_data: input control data</span>
<span class="sd">            d_data: disturbance data</span>
<span class="sd">            Tset_data: set point data</span>
<span class="sd">            TS_data: experimental data</span>
<span class="sd">            Tamb: ambient temperature, deg C</span>
<span class="sd">            alpha: watts / (units P1 * percent U1)</span>
<span class="sd">            P1: max power, P1 units</span>
<span class="sd">            Ua: heat transfer coefficient from heater to environment, watts/deg C</span>
<span class="sd">            Ub: heat transfer coefficient from heater to sensor, watts/deg C</span>
<span class="sd">            CpH: heat capacity of the heater, joules/deg C</span>
<span class="sd">            CpS: heat capacity of the, joules/deg C</span>
<span class="sd">            integrate_to_initialize: Boolean</span>
<span class="sd">            obj_weight: weight for heater temperature or disturbance in objective function, default is 0.1</span>
<span class="sd">        Returns:</span>
<span class="sd">            None </span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="c1"># establish the valid operating modes</span>
        <span class="n">valid_modes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;simulate&#39;</span><span class="p">,</span><span class="s1">&#39;optimize&#39;</span><span class="p">,</span><span class="s1">&#39;estimate&#39;</span><span class="p">,</span><span class="s1">&#39;observe&#39;</span><span class="p">]</span>

        <span class="c1"># raise an error if the user feeds in invalid operating mode</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_modes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;mode&#39; must be one of the following:&quot;</span><span class="o">+</span><span class="n">valid_modes</span><span class="p">)</span>

        <span class="c1"># define mode and data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_data</span> <span class="o">=</span> <span class="n">t_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u_data</span> <span class="o">=</span> <span class="n">u_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_data</span> <span class="o">=</span> <span class="n">d_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Tset_data</span> <span class="o">=</span> <span class="n">Tset_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TS_data</span> <span class="o">=</span> <span class="n">TS_data</span>

        <span class="c1"># set parameter values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Tamb</span> <span class="o">=</span> <span class="n">Tamb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ua</span> <span class="o">=</span> <span class="n">Ua</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ub</span> <span class="o">=</span> <span class="n">Ub</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CpH</span> <span class="o">=</span> <span class="n">CpH</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CpS</span> <span class="o">=</span> <span class="n">CpS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P1</span> <span class="o">=</span> <span class="n">P1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alphaP</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="n">P1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">integrate_to_initialize</span> <span class="o">=</span> <span class="n">integrate_to_initialize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obj_weight</span> <span class="o">=</span> <span class="n">obj_weight</span>

        <span class="c1"># create the pyomo model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_pyomo_model</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">None</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">_create_pyomo_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Method that creates and defines the pyomo model for each mode.</span>
<span class="sd">        Arguments:</span>
<span class="sd">            None</span>
<span class="sd">        Returns:</span>
<span class="sd">            m: the pyomo model</span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="c1"># create the pyomo model</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">ConcreteModel</span><span class="p">()</span>

        <span class="c1"># create the time set</span>
        <span class="n">m</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">ContinuousSet</span><span class="p">(</span><span class="n">initialize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_data</span><span class="p">)</span>  <span class="c1"># make sure the experimental time grid are discretization points</span>
        <span class="c1"># define the heater and sensor temperatures as variables</span>
        <span class="c1"># Increased temperature bounds to 85 deg C for digital twin mode</span>
        <span class="n">m</span><span class="o">.</span><span class="n">Th</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">85</span><span class="p">],</span> <span class="n">initialize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Tamb</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">Ts</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">85</span><span class="p">],</span> <span class="n">initialize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Tamb</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">helper</span><span class="p">(</span><span class="n">my_array</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Method that builds a dictionary to help initialization.</span>
<span class="sd">            Arguments:</span>
<span class="sd">                my_array: an array</span>
<span class="sd">            Returns:</span>
<span class="sd">                data: a dict {time: array_value}</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="c1"># ensure that the dimensions of array and time data match</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">my_array</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_data</span><span class="p">),</span> <span class="s2">&quot;Dimension mismatch.&quot;</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_data</span><span class="p">):</span>
                <span class="n">data</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">my_array</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">data</span>

        <span class="c1"># for the simulate, observe, estimate modes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;simulate&#39;</span><span class="p">,</span> <span class="s1">&#39;observe&#39;</span><span class="p">,</span> <span class="s1">&#39;estimate&#39;</span><span class="p">]:</span>
            <span class="c1"># control decision is a parameter initialized with the input control data dict</span>
            <span class="n">m</span><span class="o">.</span><span class="n">U</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">helper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u_data</span><span class="p">),</span> <span class="n">default</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># otherwise (optimize) control decision is a variable</span>
            <span class="n">m</span><span class="o">.</span><span class="n">U</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>

        <span class="c1"># for the simulate, optimize, estimate modes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;simulate&#39;</span><span class="p">,</span> <span class="s1">&#39;optimize&#39;</span><span class="p">,</span> <span class="s1">&#39;estimate&#39;</span><span class="p">]:</span>
            <span class="c1"># if no distrubance data exists, initialize parameter at 0</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                 <span class="n">m</span><span class="o">.</span><span class="n">D</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="c1"># otherwise initialize parameter with disturbance data dict</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">m</span><span class="o">.</span><span class="n">D</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">helper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_data</span><span class="p">))</span>
        <span class="c1"># otherwise (observe) the disturbance is a variable</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">m</span><span class="o">.</span><span class="n">D</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>

        <span class="c1"># define parameters that do not depend on mode</span>
        <span class="n">m</span><span class="o">.</span><span class="n">Tamb</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Tamb</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">alphaP</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alphaP</span><span class="p">)</span>

        <span class="c1"># for the simulate, optimize, observe modes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;simulate&#39;</span><span class="p">,</span> <span class="s1">&#39;optimize&#39;</span><span class="p">,</span> <span class="s1">&#39;observe&#39;</span><span class="p">]:</span>
            <span class="c1"># Ua and Ub parameters</span>
            <span class="n">m</span><span class="o">.</span><span class="n">Ua</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ua</span><span class="p">)</span>
            <span class="n">m</span><span class="o">.</span><span class="n">Ub</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ub</span><span class="p">)</span>
            <span class="c1"># 1/CpH and 1/CpS parameters</span>
            <span class="n">m</span><span class="o">.</span><span class="n">inv_CpH</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">CpH</span><span class="p">)</span>
            <span class="n">m</span><span class="o">.</span><span class="n">inv_CpS</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">CpS</span><span class="p">)</span>
        <span class="c1"># otherwise (estimate) they are variables</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">m</span><span class="o">.</span><span class="n">Ua</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ua</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">1E-5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">))</span>
            <span class="n">m</span><span class="o">.</span><span class="n">Ub</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ub</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">1E-5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">))</span>
            <span class="n">m</span><span class="o">.</span><span class="n">inv_CpH</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">CpH</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">1E-2</span><span class="p">,</span><span class="mi">100</span><span class="p">))</span>
            <span class="n">m</span><span class="o">.</span><span class="n">inv_CpS</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">CpS</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">1E-1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">))</span>



        <span class="c1"># define variables for change in temperature wrt to time</span>
        <span class="n">m</span><span class="o">.</span><span class="n">Thdot</span> <span class="o">=</span> <span class="n">DerivativeVar</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Th</span><span class="p">,</span> <span class="n">wrt</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">Tsdot</span> <span class="o">=</span> <span class="n">DerivativeVar</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Ts</span><span class="p">,</span> <span class="n">wrt</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>

        <span class="c1"># define differential equations (model) as contraints</span>
        <span class="c1"># moved Cps to the right hand side to diagnose integrator</span>
        <span class="n">m</span><span class="o">.</span><span class="n">Th_ode</span> <span class="o">=</span> <span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">rule</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">m</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> 
                            <span class="n">m</span><span class="o">.</span><span class="n">Thdot</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Ua</span><span class="o">*</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Tamb</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">Th</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">Ub</span><span class="o">*</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Ts</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">Th</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">alphaP</span><span class="o">*</span><span class="n">m</span><span class="o">.</span><span class="n">U</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">D</span><span class="p">[</span><span class="n">t</span><span class="p">])</span><span class="o">*</span><span class="n">m</span><span class="o">.</span><span class="n">inv_CpH</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">Ts_ode</span> <span class="o">=</span> <span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">rule</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">m</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> 
                            <span class="n">m</span><span class="o">.</span><span class="n">Tsdot</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Ub</span><span class="o">*</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Th</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">Ts</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="p">)</span><span class="o">*</span><span class="n">m</span><span class="o">.</span><span class="n">inv_CpS</span><span class="p">)</span>


        

        <span class="c1">##### Simulate to initialize</span>
        <span class="c1"># Specify time-varying input data</span>
        <span class="c1"># This is a dictionary of the form {time: value}</span>
        <span class="c1"># This is used only for the simulate mode,</span>
        <span class="c1"># which just initializes the model</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrate_to_initialize</span><span class="p">:</span>

            <span class="n">m</span><span class="o">.</span><span class="n">var_input</span> <span class="o">=</span> <span class="n">Suffix</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="n">Suffix</span><span class="o">.</span><span class="n">LOCAL</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">u_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># initialize with data</span>
                <span class="n">m</span><span class="o">.</span><span class="n">var_input</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">U</span><span class="p">]</span> <span class="o">=</span> <span class="n">helper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u_data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># otherwise initialize control decision of 0</span>
                <span class="n">m</span><span class="o">.</span><span class="n">var_input</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">U</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># initialize with data</span>
                <span class="n">m</span><span class="o">.</span><span class="n">var_input</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">D</span><span class="p">]</span> <span class="o">=</span> <span class="n">helper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># otherwise initialize disturbance of 0</span>
                <span class="n">m</span><span class="o">.</span><span class="n">var_input</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">D</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
            

            <span class="c1"># Simulate to initiialize</span>
            <span class="c1"># Makes the solver more efficient</span>
            <span class="n">sim</span> <span class="o">=</span> <span class="n">Simulator</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="s1">&#39;scipy&#39;</span><span class="p">)</span> 
            <span class="n">tsim</span><span class="p">,</span> <span class="n">profiles</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">numpoints</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> 
                                        <span class="n">integrator</span><span class="o">=</span><span class="s1">&#39;vode&#39;</span><span class="p">,</span> 
                                        <span class="n">varying_inputs</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">var_input</span><span class="p">)</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">initialize_model</span><span class="p">()</span>

        <span class="c1"># In Lab 5, you will add constraints limiting the </span>
        <span class="c1"># rate of change of the heater power (u) here.</span>

        <span class="c1"># for the optimize mode, set point data is a parameter</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;optimize&#39;</span><span class="p">:</span>
            <span class="n">m</span><span class="o">.</span><span class="n">Tset</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">helper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Tset_data</span><span class="p">))</span>
            <span class="c1"># otherwise, we are not using it</span>

        <span class="c1"># for the estimate and observe modes, experimental data is a parameter</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;estimate&#39;</span><span class="p">,</span> <span class="s1">&#39;observe&#39;</span><span class="p">]:</span>
            <span class="n">m</span><span class="o">.</span><span class="n">Ts_measure</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">helper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TS_data</span><span class="p">))</span>
            <span class="c1"># otherwise, we are not using it</span>

        <span class="c1"># apply backward finite difference to the model</span>
        <span class="n">TransformationFactory</span><span class="p">(</span><span class="s1">&#39;dae.finite_difference&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply_to</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">scheme</span><span class="o">=</span><span class="s1">&#39;BACKWARD&#39;</span><span class="p">,</span><span class="n">nfe</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_data</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;optimize&#39;</span><span class="p">:</span>
            <span class="c1"># defining the tracking objective function</span>
            <span class="n">m</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">Objective</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Ts</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">Tset</span><span class="p">[</span><span class="n">t</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_weight</span><span class="o">*</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Th</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">Tset</span><span class="p">[</span><span class="n">t</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">t</span><span class="p">),</span> <span class="n">sense</span><span class="o">=</span><span class="n">minimize</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;observe&#39;</span><span class="p">:</span>
            <span class="c1"># define observation (state estimation)</span>
            <span class="n">m</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">Objective</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="nb">sum</span><span class="p">((</span><span class="n">m</span><span class="o">.</span><span class="n">Ts</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">Ts_measure</span><span class="p">[</span><span class="n">t</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_weight</span><span class="o">*</span><span class="n">m</span><span class="o">.</span><span class="n">D</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">t</span><span class="p">),</span> <span class="n">sense</span><span class="o">=</span><span class="n">minimize</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;estimate&#39;</span><span class="p">:</span>
            <span class="c1"># define parameter estimation objective</span>
            <span class="n">m</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">Objective</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="nb">sum</span><span class="p">((</span><span class="n">m</span><span class="o">.</span><span class="n">Ts</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">Ts_measure</span><span class="p">[</span><span class="n">t</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">t</span><span class="p">),</span> <span class="n">sense</span><span class="o">=</span><span class="n">minimize</span><span class="p">)</span>

        <span class="c1"># initial conditions</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TS_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Initilize with first temperature measurement</span>
            <span class="n">m</span><span class="o">.</span><span class="n">Ts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TS_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">m</span><span class="o">.</span><span class="n">Th</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TS_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Otherwise, initialize with Tamb</span>
            <span class="n">m</span><span class="o">.</span><span class="n">Th</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Tamb</span><span class="p">)</span>
            <span class="n">m</span><span class="o">.</span><span class="n">Ts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Tamb</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">m</span>
    

    <span class="k">def</span><span class="w"> </span><span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Solves the pyomo model using ipopt.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">solver</span> <span class="o">=</span> <span class="n">SolverFactory</span><span class="p">(</span><span class="s1">&#39;ipopt&#39;</span><span class="p">)</span>
        <span class="c1">#solver.options[&#39;linear_solver&#39;] = &#39;ma57&#39;</span>
        <span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns time data from solved pyomo model.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_data</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_Th</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns heater temperature data from solved pyomo model.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">Th</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_data</span><span class="p">])</span>
    

    <span class="k">def</span><span class="w"> </span><span class="nf">get_Ts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns sensor temperature data from solved pyomo model.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">Ts</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_data</span><span class="p">])</span>
    

    <span class="k">def</span><span class="w"> </span><span class="nf">get_U</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns control decision data from solved pyomo model.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">U</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_data</span><span class="p">])</span>
    

    <span class="k">def</span><span class="w"> </span><span class="nf">get_D</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns disturbance data from solved pyomo model.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">D</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_data</span><span class="p">])</span>
    

    <span class="k">def</span><span class="w"> </span><span class="nf">get_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns model parameters from solved pyomo model.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">Ua</span><span class="p">),</span> <span class="n">value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">Ub</span><span class="p">),</span> <span class="mi">1</span><span class="o">/</span><span class="n">value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">inv_CpH</span><span class="p">),</span> <span class="mi">1</span><span class="o">/</span><span class="n">value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">inv_CpS</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">print_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Prints out the model parameters from solved pyomo model.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">Ua</span><span class="p">,</span> <span class="n">Ub</span><span class="p">,</span> <span class="n">CpH</span><span class="p">,</span> <span class="n">CpS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The value of Ua is&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">Ua</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="s2">&quot;Watts/degC.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The value of Ub is&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">Ub</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="s2">&quot;Watts/degC.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The value of CpH is&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">CpH</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="s2">&quot;Joules/degC.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The value of CpS is&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">CpS</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&quot;Joules/degC.&quot;</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Method to plot the results from the pyomo model.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># extract predictions</span>
        <span class="n">Th</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_Th</span><span class="p">()</span>
        <span class="n">Ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_Ts</span><span class="p">()</span>
        <span class="n">U</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_U</span><span class="p">()</span>
        <span class="n">D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_D</span><span class="p">()</span>

        <span class="c1"># create figure</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

        <span class="c1"># subplot 1: temperatures</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TS_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TS_data</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$T_</span><span class="si">{S}</span><span class="s2">$ measured&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_data</span><span class="p">,</span> <span class="n">Th</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$T_</span><span class="si">{H}</span><span class="s1">$ predicted&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_data</span><span class="p">,</span> <span class="n">Ts</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$T_</span><span class="si">{S}</span><span class="s1">$ predicted&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tset_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tset_data</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$T_</span><span class="si">{set}</span><span class="s1">$&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;temperatures&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;deg C&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># subplot 2: control decision</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_data</span><span class="p">,</span> <span class="n">U</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;heater power&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;percent of max&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># subplot 3: disturbance</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_data</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;disturbance&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;watts&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;time (s)&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="process-inputs">
<h3><span class="section-number">6.8.2.2. </span>Process Inputs<a class="headerlink" href="#process-inputs" title="Link to this heading">#</a></h3>
<p>The next cell defines some process inputs that will be used throughout the notebook to demonstrate aspects of process simulation, control, and estimation.  These are gathered in one place to make it easier to modify the notebook to test the response under different conditions. These functions are implemented using the <code class="docutils literal notranslate"><span class="pre">interp1d</span></code> from the <code class="docutils literal notranslate"><span class="pre">scipy</span></code> library.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline

<span class="c1"># Ambient temperature</span>
<span class="c1"># In Lab 5, you will update this based on the room&#39;s temperature</span>
<span class="n">Tamb</span> <span class="o">=</span> <span class="mf">21.0</span> <span class="c1"># deg C</span>

<span class="n">tclab_disturbance</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span>
    <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">9999</span><span class="p">],</span>   <span class="c1"># time</span>
    <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">.5</span><span class="p">],</span>      <span class="c1"># disturbance value</span>
    <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">)</span>   <span class="c1"># tolerates slight exptrapolation</span>

<span class="n">tclab_input</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span>
    <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">450</span><span class="p">,</span> <span class="mi">451</span><span class="p">,</span> <span class="mi">9999</span><span class="p">],</span>   <span class="c1"># time</span>
    <span class="p">[</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span>  <span class="mi">80</span><span class="p">,</span>   <span class="mi">25</span><span class="p">,</span>   <span class="mi">25</span><span class="p">],</span>  <span class="c1"># input value</span>
    <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">)</span>   <span class="c1"># tolerates slight exptrapolation</span>

<span class="n">tclab_setpoint</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">450</span><span class="p">,</span> <span class="mi">550</span><span class="p">,</span> <span class="mi">9999</span><span class="p">],</span>   <span class="c1"># time </span>
    <span class="p">[</span><span class="n">Tamb</span><span class="p">,</span> <span class="n">Tamb</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">35</span><span class="p">],</span>   <span class="c1"># set point value</span>
    <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">)</span>   <span class="c1"># tolerates slight exptrapolation`</span>

<span class="n">t_sim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">201</span><span class="p">)</span>       <span class="c1"># create 201 time points between 0 and 1000 seconds</span>
<span class="n">u_sim</span> <span class="o">=</span> <span class="n">tclab_input</span><span class="p">(</span><span class="n">t_sim</span><span class="p">)</span>              <span class="c1"># calculate input signal at time points</span>
<span class="n">d_sim</span> <span class="o">=</span> <span class="n">tclab_disturbance</span><span class="p">(</span><span class="n">t_sim</span><span class="p">)</span>        <span class="c1"># calculate disturbance at time points</span>
<span class="n">setpoint_sim</span> <span class="o">=</span> <span class="n">tclab_setpoint</span><span class="p">(</span><span class="n">t_sim</span><span class="p">)</span>    <span class="c1"># calculate set point at time points</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_sim</span><span class="p">,</span> <span class="n">setpoint_sim</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;setpoint&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;deg C&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_sim</span><span class="p">,</span> <span class="n">u_sim</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;heat power input&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;percent of max&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_sim</span><span class="p">,</span> <span class="n">d_sim</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;unmeasured disturbance&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;watts&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;time (s)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Lets see how well our initial guess at a control strategy will work for us.</p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
C_p^H \frac{dT_H}{dt} &amp; = U_a (T_{amb} - T_H) + U_b (T_S - T_H) + \alpha P u(t) + d(t)\\
C_p^S \frac{dT_S}{dt} &amp; = - U_b (T_S - T_H) 
\end{align*}\]</div>
<p>subject to initial conditions</p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
T_H(t_0) &amp; = T_{amb} \\
T_S(t_0) &amp; = T_{amb}
\end{align*}\]</div>
<p>and prior specification of inputs <span class="math notranslate nohighlight">\(u(t)\)</span> and <span class="math notranslate nohighlight">\(d(t)\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sim</span> <span class="o">=</span> <span class="n">TCLabPyomo</span><span class="p">(</span><span class="s1">&#39;simulate&#39;</span><span class="p">,</span>
                <span class="n">t_sim</span><span class="p">,</span>
                <span class="n">u_sim</span><span class="p">,</span>
                <span class="n">d_sim</span><span class="p">,</span>
                <span class="n">setpoint_sim</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">sim</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
<span class="n">sim</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ipopt 3.13.2: 

******************************************************************************
This program contains Ipopt, a library for large-scale nonlinear optimization.
 Ipopt is released as open source code under the Eclipse Public License (EPL).
         For more information visit http://projects.coin-or.org/Ipopt

This version of Ipopt was compiled from source code available at
    https://github.com/IDAES/Ipopt as part of the Institute for the Design of
    Advanced Energy Systems Process Systems Engineering Framework (IDAES PSE
    Framework) Copyright (c) 2018-2019. See https://github.com/IDAES/idaes-pse.

This version of Ipopt was compiled using HSL, a collection of Fortran codes
    for large-scale scientific computation.  All technical papers, sales and
    publicity material resulting from use of the HSL codes within IPOPT must
    contain the following acknowledgement:
        HSL, a collection of Fortran codes for large-scale scientific
        computation. See http://www.hsl.rl.ac.uk.
******************************************************************************

This is Ipopt version 3.13.2, running with linear solver ma27.

Number of nonzeros in equality constraint Jacobian...:     2400
Number of nonzeros in inequality constraint Jacobian.:        0
Number of nonzeros in Lagrangian Hessian.............:        0

Total number of variables............................:      802
                     variables with only lower bounds:        0
                variables with lower and upper bounds:      400
                     variables with only upper bounds:        0
Total number of equality constraints.................:      802
Total number of inequality constraints...............:        0
        inequality constraints with only lower bounds:        0
   inequality constraints with lower and upper bounds:        0
        inequality constraints with only upper bounds:        0

iter    objective    inf_pr   inf_du lg(mu)  ||d||  lg(rg) alpha_du alpha_pr  ls
   0  0.0000000e+00 5.12e-01 0.00e+00  -1.0 0.00e+00    -  0.00e+00 0.00e+00   0
   1  0.0000000e+00 3.21e-15 1.38e+00  -1.0 3.49e+01    -  3.73e-01 1.00e+00h  1

Number of Iterations....: 1

                                   (scaled)                 (unscaled)
Objective...............:   0.0000000000000000e+00    0.0000000000000000e+00
Dual infeasibility......:   0.0000000000000000e+00    0.0000000000000000e+00
Constraint violation....:   3.2057689836051395e-15    3.2057689836051395e-15
Complementarity.........:   0.0000000000000000e+00    0.0000000000000000e+00
Overall NLP error.......:   3.2057689836051395e-15    3.2057689836051395e-15


Number of objective function evaluations             = 2
Number of objective gradient evaluations             = 2
Number of equality constraint evaluations            = 2
Number of inequality constraint evaluations          = 0
Number of equality constraint Jacobian evaluations   = 2
Number of inequality constraint Jacobian evaluations = 0
Number of Lagrangian Hessian evaluations             = 1
Total CPU secs in IPOPT (w/o function evaluations)   =      0.002
Total CPU secs in NLP function evaluations           =      0.000

EXIT: Optimal Solution Found.
</pre></div>
</div>
<img alt="../../_images/dcc792a49fcabca9fc3060a811ffa650700589b087e55f89ee12b73016c48cbd.png" src="../../_images/dcc792a49fcabca9fc3060a811ffa650700589b087e55f89ee12b73016c48cbd.png" />
<img alt="../../_images/dfcb0bdfe02b8d6a8deb3309e12d5f7818edbca19cc27f374bd8724648e9ab42.png" src="../../_images/dfcb0bdfe02b8d6a8deb3309e12d5f7818edbca19cc27f374bd8724648e9ab42.png" />
</div>
</div>
</section>
</section>
<section id="optimal-control-with-knowledge-of-disturbances">
<h2><span class="section-number">6.8.3. </span>Optimal Control with Knowledge of Disturbances<a class="headerlink" href="#optimal-control-with-knowledge-of-disturbances" title="Link to this heading">#</a></h2>
<p>An optimal control policy minimizes the differences</p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
\min_{u} \int_{t_0}^{t_f} \|T_S^{SP}(t) - T_S(t)\|^2\ + w \|T_S^{SP}(t) - T_H(t)\|^2\,dt \\
\end{align*}\]</div>
<p>subject to constraints</p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
C_p^H \frac{dT_H}{dt} &amp; = U_a (T_{amb} - T_H) + U_c (T_S - T_H) + P u(t) + d(t)\\
C_p^S \frac{dT_S}{dt} &amp; = - U_c (T_S - T_H) 
\end{align*}\]</div>
<p>initial conditions</p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
T_H(t_0) &amp; = T_{amb} \\
T_S(t_0) &amp; = T_{amb}
\end{align*}\]</div>
<p>and prior knowledge of <span class="math notranslate nohighlight">\(d(t)\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">opt</span> <span class="o">=</span> <span class="n">TCLabPyomo</span><span class="p">(</span><span class="s1">&#39;optimize&#39;</span><span class="p">,</span>
                 <span class="n">t_sim</span><span class="p">,</span>
                 <span class="n">u_sim</span><span class="p">,</span>
                 <span class="n">d_sim</span><span class="p">,</span>
                 <span class="n">setpoint_sim</span><span class="p">,</span>
                 <span class="kc">None</span><span class="p">,</span>
                 <span class="n">obj_weight</span><span class="o">=</span><span class="mf">0.01</span>
<span class="p">)</span>

<span class="n">opt</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
<span class="n">opt</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ipopt 3.13.2: 

******************************************************************************
This program contains Ipopt, a library for large-scale nonlinear optimization.
 Ipopt is released as open source code under the Eclipse Public License (EPL).
         For more information visit http://projects.coin-or.org/Ipopt

This version of Ipopt was compiled from source code available at
    https://github.com/IDAES/Ipopt as part of the Institute for the Design of
    Advanced Energy Systems Process Systems Engineering Framework (IDAES PSE
    Framework) Copyright (c) 2018-2019. See https://github.com/IDAES/idaes-pse.

This version of Ipopt was compiled using HSL, a collection of Fortran codes
    for large-scale scientific computation.  All technical papers, sales and
    publicity material resulting from use of the HSL codes within IPOPT must
    contain the following acknowledgement:
        HSL, a collection of Fortran codes for large-scale scientific
        computation. See http://www.hsl.rl.ac.uk.
******************************************************************************

This is Ipopt version 3.13.2, running with linear solver ma27.

Number of nonzeros in equality constraint Jacobian...:     2601
Number of nonzeros in inequality constraint Jacobian.:        0
Number of nonzeros in Lagrangian Hessian.............:      400

Total number of variables............................:     1003
                     variables with only lower bounds:        0
                variables with lower and upper bounds:      601
                     variables with only upper bounds:        0
Total number of equality constraints.................:      802
Total number of inequality constraints...............:        0
        inequality constraints with only lower bounds:        0
   inequality constraints with lower and upper bounds:        0
        inequality constraints with only upper bounds:        0

iter    objective    inf_pr   inf_du lg(mu)  ||d||  lg(rg) alpha_du alpha_pr  ls
   0  4.3590553e+04 5.00e-01 7.80e+01  -1.0 0.00e+00    -  0.00e+00 0.00e+00   0
   1  1.7609161e+05 2.10e-15 4.92e+01  -1.0 4.52e+01    -  1.94e-02 1.00e+00h  1
   2  4.4312486e+04 2.69e-15 1.82e+01  -1.0 1.35e+02    -  4.73e-03 7.27e-01f  1
   3  4.5351328e+03 2.61e-15 4.43e+00  -1.0 7.82e+01    -  1.66e-01 8.00e-01f  1
   4  4.9045017e+02 2.28e-15 6.94e-01  -1.0 3.28e+01    -  2.55e-01 8.53e-01f  1
   5  2.0157778e+02 2.34e-15 4.42e-01  -1.0 2.40e+01    -  3.55e-01 1.00e+00f  1
   6  1.6575864e+02 2.22e-15 2.83e-01  -1.0 1.93e+01    -  4.28e-01 1.00e+00f  1
   7  1.5100971e+02 2.78e-15 1.57e-01  -1.0 1.88e+01    -  4.68e-01 1.00e+00f  1
   8  1.4418673e+02 2.23e-15 6.00e-02  -1.0 1.50e+01    -  6.40e-01 1.00e+00f  1
   9  1.4018857e+02 2.41e-15 1.19e-02  -1.0 2.89e+01    -  8.20e-01 1.00e+00f  1
iter    objective    inf_pr   inf_du lg(mu)  ||d||  lg(rg) alpha_du alpha_pr  ls
  10  1.3880583e+02 2.21e-15 2.88e-03  -1.0 3.13e+01    -  1.00e+00 8.55e-01f  1
  11  1.3550555e+02 2.19e-15 7.52e-15  -1.7 1.79e+01    -  1.00e+00 1.00e+00f  1
  12  1.3447858e+02 2.64e-15 3.64e-03  -2.5 1.30e+01    -  6.65e-01 1.00e+00f  1
  13  1.3424026e+02 2.16e-15 4.31e-04  -3.8 1.03e+01    -  9.26e-01 1.00e+00f  1
  14  1.3420930e+02 2.55e-15 7.12e-15  -3.8 6.39e+00    -  1.00e+00 1.00e+00f  1
  15  1.3419823e+02 2.71e-15 7.51e-06  -5.7 3.32e+00    -  9.63e-01 1.00e+00f  1
  16  1.3419787e+02 2.48e-15 9.68e-15  -5.7 5.11e+00    -  1.00e+00 1.00e+00f  1
  17  1.3419783e+02 2.28e-15 6.90e-15  -5.7 1.52e+01    -  1.00e+00 1.00e+00f  1
  18  1.3419773e+02 2.61e-15 7.21e-15  -8.6 1.45e-02    -  1.00e+00 1.00e+00f  1

Number of Iterations....: 18

                                   (scaled)                 (unscaled)
Objective...............:   1.3419773060809698e+02    1.3419773060809698e+02
Dual infeasibility......:   7.2051086499059460e-15    7.2051086499059460e-15
Constraint violation....:   2.6088628220262246e-15    2.6088628220262246e-15
Complementarity.........:   8.7906857272874773e-09    8.7906857272874773e-09
Overall NLP error.......:   8.7906857272874773e-09    8.7906857272874773e-09


Number of objective function evaluations             = 19
Number of objective gradient evaluations             = 19
Number of equality constraint evaluations            = 19
Number of inequality constraint evaluations          = 0
Number of equality constraint Jacobian evaluations   = 19
Number of inequality constraint Jacobian evaluations = 0
Number of Lagrangian Hessian evaluations             = 18
Total CPU secs in IPOPT (w/o function evaluations)   =      0.012
Total CPU secs in NLP function evaluations           =      0.000

EXIT: Optimal Solution Found.
</pre></div>
</div>
<img alt="../../_images/b7efec15f2586aaf14bb0a3fbcc261edbd8678ac16b5f7c66fcfe1442517cbc4.png" src="../../_images/b7efec15f2586aaf14bb0a3fbcc261edbd8678ac16b5f7c66fcfe1442517cbc4.png" />
</div>
</div>
</section>
<section id="hardware-implementation">
<h2><span class="section-number">6.8.4. </span>Hardware Implementation<a class="headerlink" href="#hardware-implementation" title="Link to this heading">#</a></h2>
<p>Implement your calculated solution on the TC Lab hardware (in digital twin mode). Save the simulation results to a text file.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">perform_hardware_simulation</span><span class="p">(</span><span class="n">opt</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; </span>
<span class="sd">    This function applies the optimized control to the hardware (digital twin).</span>

<span class="sd">    Arguments:</span>
<span class="sd">        opt: TCLabPyomo object</span>

<span class="sd">    Returns:</span>
<span class="sd">        h: Historian object</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">t_solution</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">get_time</span><span class="p">()</span>
    <span class="n">u_solution</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">get_U</span><span class="p">()</span>
    <span class="n">TS_solution</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">get_Ts</span><span class="p">()</span>
    <span class="n">TH_solution</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">get_Th</span><span class="p">()</span>

    <span class="n">u_open_loop</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span>
        <span class="n">t_solution</span><span class="p">,</span>   <span class="c1"># time</span>
        <span class="n">u_solution</span><span class="p">,</span>   <span class="c1"># control value</span>
        <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">)</span>   <span class="c1"># tolerates slight exptrapolation</span>

    <span class="n">TS_predict</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span>
        <span class="n">t_solution</span><span class="p">,</span>   <span class="c1"># time</span>
        <span class="n">TS_solution</span><span class="p">,</span>   <span class="c1"># sensor temperature prediction</span>
        <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">)</span>   <span class="c1"># tolerates slight exptrapolation</span>

    <span class="n">TH_predict</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span>
        <span class="n">t_solution</span><span class="p">,</span>   <span class="c1"># time</span>
        <span class="n">TH_solution</span><span class="p">,</span>   <span class="c1"># sensor temperature prediction</span>
        <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">)</span>   <span class="c1"># tolerates slight exptrapolation</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">tclab</span><span class="w"> </span><span class="kn">import</span> <span class="n">TCLab</span><span class="p">,</span> <span class="n">clock</span><span class="p">,</span> <span class="n">Historian</span><span class="p">,</span> <span class="n">Plotter</span><span class="p">,</span> <span class="n">setup</span>

    <span class="c1"># In Lab 5, you will use connected=True</span>
    <span class="c1"># And run this experiment on your hardware</span>
    <span class="n">TCLab</span> <span class="o">=</span> <span class="n">setup</span><span class="p">(</span><span class="n">connected</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">speedup</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

    <span class="c1"># Set final time to match simulation</span>
    <span class="n">t_final</span> <span class="o">=</span> <span class="n">t_solution</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Only implement the controller change every 2 seconds</span>
    <span class="n">t_step</span> <span class="o">=</span> <span class="mf">2.0</span>

    <span class="c1"># Run experiments</span>
    <span class="k">with</span> <span class="n">TCLab</span><span class="p">()</span> <span class="k">as</span> <span class="n">lab</span><span class="p">:</span>

        <span class="c1"># Define sources for plotting</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;T1&quot;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">lab</span><span class="o">.</span><span class="n">T1</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;T2&quot;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">lab</span><span class="o">.</span><span class="n">T2</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;T1pred&quot;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">TS_predict</span><span class="p">(</span><span class="n">t</span><span class="p">)),</span>
                <span class="p">(</span><span class="s2">&quot;SP1&quot;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">tclab_setpoint</span><span class="p">(</span><span class="n">t</span><span class="p">)),</span>
                <span class="p">(</span><span class="s2">&quot;Q1&quot;</span><span class="p">,</span> <span class="n">lab</span><span class="o">.</span><span class="n">Q1</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;Q2&quot;</span><span class="p">,</span> <span class="n">lab</span><span class="o">.</span><span class="n">Q2</span><span class="p">)]</span>
        
        <span class="c1"># Create a historian to store data</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">Historian</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span>
        <span class="c1"># Define plotting using same names as sources/historian</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">Plotter</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">t_final</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="p">((</span><span class="s2">&quot;T1&quot;</span><span class="p">,</span> <span class="s2">&quot;SP1&quot;</span><span class="p">,</span><span class="s2">&quot;T1pred&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;T2&quot;</span><span class="p">,),</span> <span class="p">(</span><span class="s2">&quot;Q1&quot;</span><span class="p">,</span> <span class="s2">&quot;Q2&quot;</span><span class="p">)))</span>

        <span class="n">lab</span><span class="o">.</span><span class="n">P1</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">P1</span>

        <span class="c1"># Loop over time steps</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">clock</span><span class="p">(</span><span class="n">t_final</span><span class="p">,</span> <span class="n">t_step</span><span class="p">):</span>
            <span class="c1"># Look up the control value via interpolation</span>
            <span class="n">U1</span> <span class="o">=</span> <span class="n">u_open_loop</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

            <span class="c1"># Notice, we did not apply the distrubance here</span>

            <span class="c1"># Set control value to hardware</span>
            <span class="n">lab</span><span class="o">.</span><span class="n">Q1</span><span class="p">(</span><span class="n">U1</span><span class="p">)</span>

            <span class="c1"># Update the plot</span>
            <span class="n">p</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">h</span>

<span class="n">h</span> <span class="o">=</span> <span class="n">perform_hardware_simulation</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/e8345189e63330dff0662ec117c2a13a7aff414adb331c8dd3c6f556cfd7651c.png" src="../../_images/e8345189e63330dff0662ec117c2a13a7aff414adb331c8dd3c6f556cfd7651c.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>TCLab Model disconnected successfully.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os.path</span>

<span class="k">def</span><span class="w"> </span><span class="nf">save_tclab_data</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">overwrite_file</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Save TCLab data to csv file</span>
<span class="sd">    Arguments:</span>
<span class="sd">        h: tclab historian objective</span>
<span class="sd">        file_name: valid file name as a string</span>
<span class="sd">        overwrite_file: bool, if True, overwrite exisiting file</span>
<span class="sd">            default is False to safeguard against accidentally rerunning this function</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite_file</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="o">+</span><span class="n">file_name</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileExistsError</span><span class="p">(</span><span class="n">file_name</span> <span class="o">+</span> <span class="s1">&#39; already exisits. Either choose a new filename or set overwrite_file = True.&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">h</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Successfully saved data to &quot;</span><span class="o">+</span><span class="n">file_name</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">file_name</span>

<span class="c1"># Warning: if you run this on Colab, you may need to adjust the file path</span>
<span class="c1"># You may get an error about the folder &#39;data&#39; not existing</span>
<span class="n">excercise2_tclab_data_file</span> <span class="o">=</span> <span class="s1">&#39;../data/tclab-open-loop-digital-twin.csv&#39;</span>

<span class="n">data_file</span> <span class="o">=</span> <span class="n">save_tclab_data</span><span class="p">(</span><span class="n">h</span><span class="p">,</span>
                <span class="n">excercise2_tclab_data_file</span><span class="p">,</span>
                <span class="kc">False</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Successfully saved data to ../data/tclab-open-loop-digital-twin.csv
</pre></div>
</div>
</div>
</div>
</section>
<section id="estimation-observation">
<h2><span class="section-number">6.8.5. </span>Estimation/Observation<a class="headerlink" href="#estimation-observation" title="Link to this heading">#</a></h2>
<blockquote>
<div><p> and now my watch begins  The Nights Watch oath, Game of Thrones</p>
</div></blockquote>
<p>The trouble with open-loop optimal control is that we cannot anticipate or know the values of unmeasured disturbances, much less the future values of those disturbances. The best we can do is use available data and process models to estimate the process state and disturbances. The state estimation problem is:</p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
\min_{\hat{T}_H, \hat{T}_S, \hat{d}} \int_{t - h}^t (\|\hat{T}_S(t) - T_S(t)\|^2\, + wd(t)^2 ) dt \\
\end{align*}\]</div>
<p>subject to</p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
C_p^H \frac{d\hat{T}_H}{dt} &amp; = U_a (T_{amb} - \hat{T}_H) + U_c (\hat{T}_S - \hat{T}_H) + P u(t) + \hat{d}(t)\\
C_p^S \frac{d\hat{T}_S}{dt} &amp; = - U_c (\hat{T}_S - \hat{T}_H) 
\end{align*}\]</div>
<p>and initial conditions</p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
T_H(t_0) &amp; = T_{amb} \\
T_S(t_0) &amp; = T_{amb}
\end{align*}\]</div>
<p>Using the experimental data generated above, estimate the heater temperature and disturbance.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># local data file</span>
<span class="n">excercise3_tclab_data_file</span> <span class="o">=</span> <span class="s1">&#39;../data/tclab-open-loop-digital-twin.csv&#39;</span>

<span class="c1"># saved data file</span>
<span class="c1"># excercise3_tclab_data_file = &quot;https://raw.githubusercontent.com/ndcbe/controls/main/notebooks/data/tclab-open-loop-digital-twin.csv&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="n">experiment_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">excercise3_tclab_data_file</span><span class="p">)</span>
<span class="n">experiment_data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Time</th>
      <th>T1</th>
      <th>T2</th>
      <th>T1pred</th>
      <th>SP1</th>
      <th>Q1</th>
      <th>Q2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>3.193803</td>
      <td>20.9495</td>
      <td>20.6272</td>
      <td>21.0</td>
      <td>21.0</td>
      <td>5.000000e+01</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>7.207467</td>
      <td>20.9495</td>
      <td>20.9495</td>
      <td>21.0</td>
      <td>21.0</td>
      <td>9.900000e+00</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>9.295027</td>
      <td>20.9495</td>
      <td>20.9495</td>
      <td>21.0</td>
      <td>21.0</td>
      <td>4.587599e-09</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>11.332593</td>
      <td>20.9495</td>
      <td>20.9495</td>
      <td>21.0</td>
      <td>21.0</td>
      <td>4.748570e-09</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>13.249835</td>
      <td>21.2718</td>
      <td>20.9495</td>
      <td>21.0</td>
      <td>21.0</td>
      <td>4.904650e-09</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">time_data</span> <span class="o">=</span> <span class="n">experiment_data</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span> <span class="c1"># grab column from pandas, convert to array</span>
<span class="n">time_data</span> <span class="o">-=</span> <span class="n">time_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># make initial time 0</span>

<span class="n">u_data</span> <span class="o">=</span> <span class="n">experiment_data</span><span class="p">[</span><span class="s1">&#39;Q1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span>
<span class="n">T1_data</span> <span class="o">=</span> <span class="n">experiment_data</span><span class="p">[</span><span class="s1">&#39;T1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span>
</pre></div>
</div>
</div>
</div>
<section id="small-objective-weight-w-0-01">
<h3><span class="section-number">6.8.5.1. </span>Small Objective Weight (<span class="math notranslate nohighlight">\(w=0.01\)</span>)<a class="headerlink" href="#small-objective-weight-w-0-01" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obs</span> <span class="o">=</span> <span class="n">TCLabPyomo</span><span class="p">(</span><span class="s1">&#39;observe&#39;</span><span class="p">,</span>
                 <span class="n">time_data</span><span class="p">,</span>
                 <span class="n">u_data</span><span class="p">,</span>
                 <span class="kc">None</span><span class="p">,</span>
                 <span class="kc">None</span><span class="p">,</span>
                 <span class="n">T1_data</span><span class="p">,</span>
                <span class="n">obj_weight</span><span class="o">=</span><span class="mf">0.01</span>
<span class="p">)</span>

<span class="n">obs</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
<span class="n">obs</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ipopt 3.13.2: 

******************************************************************************
This program contains Ipopt, a library for large-scale nonlinear optimization.
 Ipopt is released as open source code under the Eclipse Public License (EPL).
         For more information visit http://projects.coin-or.org/Ipopt

This version of Ipopt was compiled from source code available at
    https://github.com/IDAES/Ipopt as part of the Institute for the Design of
    Advanced Energy Systems Process Systems Engineering Framework (IDAES PSE
    Framework) Copyright (c) 2018-2019. See https://github.com/IDAES/idaes-pse.

This version of Ipopt was compiled using HSL, a collection of Fortran codes
    for large-scale scientific computation.  All technical papers, sales and
    publicity material resulting from use of the HSL codes within IPOPT must
    contain the following acknowledgement:
        HSL, a collection of Fortran codes for large-scale scientific
        computation. See http://www.hsl.rl.ac.uk.
******************************************************************************

This is Ipopt version 3.13.2, running with linear solver ma27.

Number of nonzeros in equality constraint Jacobian...:     5110
Number of nonzeros in inequality constraint Jacobian.:        0
Number of nonzeros in Lagrangian Hessian.............:      787

Total number of variables............................:     1968
                     variables with only lower bounds:        0
                variables with lower and upper bounds:      786
                     variables with only upper bounds:        0
Total number of equality constraints.................:     1574
Total number of inequality constraints...............:        0
        inequality constraints with only lower bounds:        0
   inequality constraints with lower and upper bounds:        0
        inequality constraints with only upper bounds:        0

iter    objective    inf_pr   inf_du lg(mu)  ||d||  lg(rg) alpha_du alpha_pr  ls
   0  2.9469014e+03 5.75e-01 6.54e+00  -1.0 0.00e+00    -  0.00e+00 0.00e+00   0
   1  1.2001210e+01 6.39e-15 7.63e-02  -1.0 6.41e+00    -  7.86e-01 1.00e+00f  1
   2  2.6037599e+00 6.01e-15 3.50e-03  -1.0 2.35e+00    -  9.88e-01 1.00e+00f  1
   3  2.5980327e+00 5.97e-15 7.06e-15  -1.7 1.08e-01    -  1.00e+00 1.00e+00f  1
   4  2.5979934e+00 5.38e-15 7.07e-15  -3.8 5.96e-03    -  1.00e+00 1.00e+00f  1
   5  2.5979933e+00 6.18e-15 7.08e-15  -5.7 4.59e-05    -  1.00e+00 1.00e+00h  1
   6  2.5979933e+00 6.33e-15 7.11e-15  -8.6 5.50e-07    -  1.00e+00 1.00e+00h  1

Number of Iterations....: 6

                                   (scaled)                 (unscaled)
Objective...............:   2.5979933483621456e+00    2.5979933483621456e+00
Dual infeasibility......:   7.1109890156373430e-15    7.1109890156373430e-15
Constraint violation....:   6.3282712403633923e-15    6.3282712403633923e-15
Complementarity.........:   2.5059362895094823e-09    2.5059362895094823e-09
Overall NLP error.......:   2.5059362895094823e-09    2.5059362895094823e-09


Number of objective function evaluations             = 7
Number of objective gradient evaluations             = 7
Number of equality constraint evaluations            = 7
Number of inequality constraint evaluations          = 0
Number of equality constraint Jacobian evaluations   = 7
Number of inequality constraint Jacobian evaluations = 0
Number of Lagrangian Hessian evaluations             = 6
Total CPU secs in IPOPT (w/o function evaluations)   =      0.009
Total CPU secs in NLP function evaluations           =      0.000

EXIT: Optimal Solution Found.
</pre></div>
</div>
<img alt="../../_images/e8345189e63330dff0662ec117c2a13a7aff414adb331c8dd3c6f556cfd7651c.png" src="../../_images/e8345189e63330dff0662ec117c2a13a7aff414adb331c8dd3c6f556cfd7651c.png" />
<img alt="../../_images/b7d5acfd23c90b499b1aa0eeab65b5fb8ea56585a5da0f3e189fb41fbabf356a.png" src="../../_images/b7d5acfd23c90b499b1aa0eeab65b5fb8ea56585a5da0f3e189fb41fbabf356a.png" />
</div>
</div>
</section>
<section id="medium-objective-weight-w-0-1">
<h3><span class="section-number">6.8.5.2. </span>Medium Objective Weight (<span class="math notranslate nohighlight">\(w=0.1\)</span>)<a class="headerlink" href="#medium-objective-weight-w-0-1" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obs</span> <span class="o">=</span> <span class="n">TCLabPyomo</span><span class="p">(</span><span class="s1">&#39;observe&#39;</span><span class="p">,</span>
                 <span class="n">time_data</span><span class="p">,</span>
                 <span class="n">u_data</span><span class="p">,</span>
                 <span class="kc">None</span><span class="p">,</span>
                 <span class="kc">None</span><span class="p">,</span>
                 <span class="n">T1_data</span><span class="p">,</span>
                <span class="n">obj_weight</span><span class="o">=</span><span class="mf">0.1</span>
<span class="p">)</span>

<span class="n">obs</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
<span class="n">obs</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ipopt 3.13.2: 

******************************************************************************
This program contains Ipopt, a library for large-scale nonlinear optimization.
 Ipopt is released as open source code under the Eclipse Public License (EPL).
         For more information visit http://projects.coin-or.org/Ipopt

This version of Ipopt was compiled from source code available at
    https://github.com/IDAES/Ipopt as part of the Institute for the Design of
    Advanced Energy Systems Process Systems Engineering Framework (IDAES PSE
    Framework) Copyright (c) 2018-2019. See https://github.com/IDAES/idaes-pse.

This version of Ipopt was compiled using HSL, a collection of Fortran codes
    for large-scale scientific computation.  All technical papers, sales and
    publicity material resulting from use of the HSL codes within IPOPT must
    contain the following acknowledgement:
        HSL, a collection of Fortran codes for large-scale scientific
        computation. See http://www.hsl.rl.ac.uk.
******************************************************************************

This is Ipopt version 3.13.2, running with linear solver ma27.

Number of nonzeros in equality constraint Jacobian...:     5110
Number of nonzeros in inequality constraint Jacobian.:        0
Number of nonzeros in Lagrangian Hessian.............:      787

Total number of variables............................:     1968
                     variables with only lower bounds:        0
                variables with lower and upper bounds:      786
                     variables with only upper bounds:        0
Total number of equality constraints.................:     1574
Total number of inequality constraints...............:        0
        inequality constraints with only lower bounds:        0
   inequality constraints with lower and upper bounds:        0
        inequality constraints with only upper bounds:        0

iter    objective    inf_pr   inf_du lg(mu)  ||d||  lg(rg) alpha_du alpha_pr  ls
   0  2.9469014e+03 5.75e-01 6.54e+00  -1.0 0.00e+00    -  0.00e+00 0.00e+00   0
   1  1.3930907e+01 6.95e-15 7.02e-02  -1.0 5.73e+00    -  7.92e-01 1.00e+00f  1
   2  5.4091718e+00 5.67e-15 9.64e-04  -1.0 4.73e-01    -  9.96e-01 1.00e+00f  1
   3  5.4084657e+00 6.12e-15 7.07e-15  -1.7 1.30e-02    -  1.00e+00 1.00e+00f  1
   4  5.4084344e+00 5.44e-15 7.10e-15  -3.8 1.42e-03    -  1.00e+00 1.00e+00f  1
   5  5.4084344e+00 5.94e-15 7.10e-15  -5.7 1.07e-05    -  1.00e+00 1.00e+00h  1
   6  5.4084344e+00 5.72e-15 7.08e-15  -8.6 1.31e-07    -  1.00e+00 1.00e+00h  1

Number of Iterations....: 6

                                   (scaled)                 (unscaled)
Objective...............:   5.4084343920839917e+00    5.4084343920839917e+00
Dual infeasibility......:   7.0797549337876918e-15    7.0797549337876918e-15
Constraint violation....:   5.7245874707234634e-15    5.7245874707234634e-15
Complementarity.........:   2.5059146251064026e-09    2.5059146251064026e-09
Overall NLP error.......:   2.5059146251064026e-09    2.5059146251064026e-09


Number of objective function evaluations             = 7
Number of objective gradient evaluations             = 7
Number of equality constraint evaluations            = 7
Number of inequality constraint evaluations          = 0
Number of equality constraint Jacobian evaluations   = 7
Number of inequality constraint Jacobian evaluations = 0
Number of Lagrangian Hessian evaluations             = 6
Total CPU secs in IPOPT (w/o function evaluations)   =      0.009
Total CPU secs in NLP function evaluations           =      0.000

EXIT: Optimal Solution Found.
</pre></div>
</div>
<img alt="../../_images/7c375fece8a10c82f6171a4bca0c703809d309dd86a7cb917df83035032543ca.png" src="../../_images/7c375fece8a10c82f6171a4bca0c703809d309dd86a7cb917df83035032543ca.png" />
</div>
</div>
</section>
<section id="medium-large-objective-weight-w-1">
<h3><span class="section-number">6.8.5.3. </span>Medium Large Objective Weight (<span class="math notranslate nohighlight">\(w=1\)</span>)<a class="headerlink" href="#medium-large-objective-weight-w-1" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obs</span> <span class="o">=</span> <span class="n">TCLabPyomo</span><span class="p">(</span><span class="s1">&#39;observe&#39;</span><span class="p">,</span>
                 <span class="n">time_data</span><span class="p">,</span>
                 <span class="n">u_data</span><span class="p">,</span>
                 <span class="kc">None</span><span class="p">,</span>
                 <span class="kc">None</span><span class="p">,</span>
                 <span class="n">T1_data</span><span class="p">,</span>
                <span class="n">obj_weight</span><span class="o">=</span><span class="mf">1.0</span>
<span class="p">)</span>

<span class="n">obs</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
<span class="n">obs</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ipopt 3.13.2: 

******************************************************************************
This program contains Ipopt, a library for large-scale nonlinear optimization.
 Ipopt is released as open source code under the Eclipse Public License (EPL).
         For more information visit http://projects.coin-or.org/Ipopt

This version of Ipopt was compiled from source code available at
    https://github.com/IDAES/Ipopt as part of the Institute for the Design of
    Advanced Energy Systems Process Systems Engineering Framework (IDAES PSE
    Framework) Copyright (c) 2018-2019. See https://github.com/IDAES/idaes-pse.

This version of Ipopt was compiled using HSL, a collection of Fortran codes
    for large-scale scientific computation.  All technical papers, sales and
    publicity material resulting from use of the HSL codes within IPOPT must
    contain the following acknowledgement:
        HSL, a collection of Fortran codes for large-scale scientific
        computation. See http://www.hsl.rl.ac.uk.
******************************************************************************

This is Ipopt version 3.13.2, running with linear solver ma27.

Number of nonzeros in equality constraint Jacobian...:     5110
Number of nonzeros in inequality constraint Jacobian.:        0
Number of nonzeros in Lagrangian Hessian.............:      787

Total number of variables............................:     1968
                     variables with only lower bounds:        0
                variables with lower and upper bounds:      786
                     variables with only upper bounds:        0
Total number of equality constraints.................:     1574
Total number of inequality constraints...............:        0
        inequality constraints with only lower bounds:        0
   inequality constraints with lower and upper bounds:        0
        inequality constraints with only upper bounds:        0

iter    objective    inf_pr   inf_du lg(mu)  ||d||  lg(rg) alpha_du alpha_pr  ls
   0  2.9469014e+03 5.75e-01 6.54e+00  -1.0 0.00e+00    -  0.00e+00 0.00e+00   0
   1  3.1652109e+01 7.38e-15 7.55e-02  -1.0 5.83e+00    -  7.85e-01 1.00e+00f  1
   2  2.3471999e+01 6.04e-15 9.05e-04  -1.0 3.55e-01    -  9.97e-01 1.00e+00f  1
   3  2.3471512e+01 6.72e-15 7.16e-15  -1.7 4.70e-03    -  1.00e+00 1.00e+00f  1
   4  2.3471483e+01 5.55e-15 7.11e-15  -3.8 9.54e-04    -  1.00e+00 1.00e+00f  1
   5  2.3471483e+01 5.91e-15 7.24e-15  -5.7 7.19e-06    -  1.00e+00 1.00e+00h  1
   6  2.3471483e+01 6.03e-15 7.11e-15  -8.6 8.84e-08    -  1.00e+00 1.00e+00h  1

Number of Iterations....: 6

                                   (scaled)                 (unscaled)
Objective...............:   2.3471482624769124e+01    2.3471482624769124e+01
Dual infeasibility......:   7.1079456791974175e-15    7.1079456791974175e-15
Constraint violation....:   6.0252939452356168e-15    6.0252939452356168e-15
Complementarity.........:   2.5059112226440714e-09    2.5059112226440714e-09
Overall NLP error.......:   2.5059112226440714e-09    2.5059112226440714e-09


Number of objective function evaluations             = 7
Number of objective gradient evaluations             = 7
Number of equality constraint evaluations            = 7
Number of inequality constraint evaluations          = 0
Number of equality constraint Jacobian evaluations   = 7
Number of inequality constraint Jacobian evaluations = 0
Number of Lagrangian Hessian evaluations             = 6
Total CPU secs in IPOPT (w/o function evaluations)   =      0.009
Total CPU secs in NLP function evaluations           =      0.000

EXIT: Optimal Solution Found.
</pre></div>
</div>
<img alt="../../_images/98d5c1ee2754c96cacfe9758671080fafc838b0b0a21465feaa84e662722e174.png" src="../../_images/98d5c1ee2754c96cacfe9758671080fafc838b0b0a21465feaa84e662722e174.png" />
</div>
</div>
</section>
<section id="extra-large-objective-weight-w-10">
<h3><span class="section-number">6.8.5.4. </span>Extra Large Objective Weight (<span class="math notranslate nohighlight">\(w=10\)</span>)<a class="headerlink" href="#extra-large-objective-weight-w-10" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obs</span> <span class="o">=</span> <span class="n">TCLabPyomo</span><span class="p">(</span><span class="s1">&#39;observe&#39;</span><span class="p">,</span>
                 <span class="n">time_data</span><span class="p">,</span>
                 <span class="n">u_data</span><span class="p">,</span>
                 <span class="kc">None</span><span class="p">,</span>
                 <span class="kc">None</span><span class="p">,</span>
                 <span class="n">T1_data</span><span class="p">,</span>
                <span class="n">obj_weight</span><span class="o">=</span><span class="mf">10.0</span>
<span class="p">)</span>

<span class="n">obs</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
<span class="n">obs</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ipopt 3.13.2: 

******************************************************************************
This program contains Ipopt, a library for large-scale nonlinear optimization.
 Ipopt is released as open source code under the Eclipse Public License (EPL).
         For more information visit http://projects.coin-or.org/Ipopt

This version of Ipopt was compiled from source code available at
    https://github.com/IDAES/Ipopt as part of the Institute for the Design of
    Advanced Energy Systems Process Systems Engineering Framework (IDAES PSE
    Framework) Copyright (c) 2018-2019. See https://github.com/IDAES/idaes-pse.

This version of Ipopt was compiled using HSL, a collection of Fortran codes
    for large-scale scientific computation.  All technical papers, sales and
    publicity material resulting from use of the HSL codes within IPOPT must
    contain the following acknowledgement:
        HSL, a collection of Fortran codes for large-scale scientific
        computation. See http://www.hsl.rl.ac.uk.
******************************************************************************

This is Ipopt version 3.13.2, running with linear solver ma27.

Number of nonzeros in equality constraint Jacobian...:     5110
Number of nonzeros in inequality constraint Jacobian.:        0
Number of nonzeros in Lagrangian Hessian.............:      787

Total number of variables............................:     1968
                     variables with only lower bounds:        0
                variables with lower and upper bounds:      786
                     variables with only upper bounds:        0
Total number of equality constraints.................:     1574
Total number of inequality constraints...............:        0
        inequality constraints with only lower bounds:        0
   inequality constraints with lower and upper bounds:        0
        inequality constraints with only upper bounds:        0

iter    objective    inf_pr   inf_du lg(mu)  ||d||  lg(rg) alpha_du alpha_pr  ls
   0  2.9469014e+03 5.75e-01 6.54e+00  -1.0 0.00e+00    -  0.00e+00 0.00e+00   0
   1  1.6047281e+02 6.52e-15 7.53e-02  -1.0 5.86e+00    -  7.87e-01 1.00e+00f  1
   2  1.5316445e+02 6.37e-15 1.00e-03  -1.0 2.84e-01    -  9.96e-01 1.00e+00f  1
   3  1.5316409e+02 6.25e-15 7.55e-15  -1.7 2.87e-03    -  1.00e+00 1.00e+00f  1
   4  1.5316406e+02 5.42e-15 8.10e-15  -3.8 5.34e-04    -  1.00e+00 1.00e+00f  1
   5  1.5316406e+02 5.53e-15 7.59e-15  -5.7 4.01e-06    -  1.00e+00 1.00e+00h  1
   6  1.5316406e+02 5.63e-15 7.68e-15  -8.6 4.95e-08    -  1.00e+00 1.00e+00h  1

Number of Iterations....: 6

                                   (scaled)                 (unscaled)
Objective...............:   1.5316406366012535e+02    1.5316406366012535e+02
Dual infeasibility......:   7.6750253700080050e-15    7.6750253700080050e-15
Constraint violation....:   5.6260552113772058e-15    5.6260552113772058e-15
Complementarity.........:   2.5059080998969592e-09    2.5059080998969592e-09
Overall NLP error.......:   2.5059080998969592e-09    2.5059080998969592e-09


Number of objective function evaluations             = 7
Number of objective gradient evaluations             = 7
Number of equality constraint evaluations            = 7
Number of inequality constraint evaluations          = 0
Number of equality constraint Jacobian evaluations   = 7
Number of inequality constraint Jacobian evaluations = 0
Number of Lagrangian Hessian evaluations             = 6
Total CPU secs in IPOPT (w/o function evaluations)   =      0.009
Total CPU secs in NLP function evaluations           =      0.000

EXIT: Optimal Solution Found.
</pre></div>
</div>
<img alt="../../_images/865360ecca462d5879bbe5631f6316c89372824c101937444fba3cb25e39a703.png" src="../../_images/865360ecca462d5879bbe5631f6316c89372824c101937444fba3cb25e39a703.png" />
</div>
</div>
</section>
</section>
<section id="parameter-estimation">
<h2><span class="section-number">6.8.6. </span>Parameter Estimation<a class="headerlink" href="#parameter-estimation" title="Link to this heading">#</a></h2>
<p>It is also possible our model does not match the physics of the system (e.g., wrong assumptions) or our estimated parameters are no longer valid or both. To investigate the later, we can repeat the parameter estimation problem for earlier in the semester:</p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
\min_{\hat{T}_H, \hat{T}_S, \hat{U_a}, \hat{U_b}, \hat{C_p^H}, \hat{C_p^S}} \int_{t - h}^t \|\hat{T}_S(t) - T_S(t)\|^2\,dt \\
\end{align*}\]</div>
<p>subject to</p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
\hat{C_p^H} \frac{d\hat{T}_H}{dt} &amp; = \hat{U_a} (T_{amb} - \hat{T}_H) + \hat{U_b} (\hat{T}_S - \hat{T}_H) + \alpha P u(t) + d(t)\\
\hat{C_p^S} \frac{d\hat{T}_S}{dt} &amp; = - \hat{U_b} (\hat{T}_S - \hat{T}_H) 
\end{align*}\]</div>
<p>and initial conditions</p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
T_H(t_0) &amp; = T_{amb} \\
T_S(t_0) &amp; = T_{amb}
\end{align*}\]</div>
<p>and (optionally) the assumption disturbance is zero</p>
<div class="amsmath math notranslate nohighlight" id="equation-95ae7456-6b81-4dde-867b-f4d34633a4b9">
<span class="eqno">(6.1)<a class="headerlink" href="#equation-95ae7456-6b81-4dde-867b-f4d34633a4b9" title="Permalink to this equation">#</a></span>\[\begin{equation}
d(t) = 0
\end{equation}\]</div>
<p>Using data from your experiment, restimate the model parameters <span class="math notranslate nohighlight">\(U_a\)</span>, <span class="math notranslate nohighlight">\(U_b\)</span>, <span class="math notranslate nohighlight">\(C_p^H\)</span>, <span class="math notranslate nohighlight">\(C_p^S\)</span>.</p>
<p>NOTE: Depending on your computers hardward and the version of Ipopt installed, the following code cell may take up to 2 minutes to solve.</p>
<section id="assume-no-disturbance">
<h3><span class="section-number">6.8.6.1. </span>Assume no disturbance<a class="headerlink" href="#assume-no-disturbance" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">est</span> <span class="o">=</span> <span class="n">TCLabPyomo</span><span class="p">(</span><span class="s1">&#39;estimate&#39;</span><span class="p">,</span>
                 <span class="n">time_data</span><span class="p">,</span>
                 <span class="n">u_data</span><span class="p">,</span>
                 <span class="kc">None</span><span class="p">,</span> <span class="c1"># assume d(t) = 0</span>
                 <span class="kc">None</span><span class="p">,</span>
                 <span class="n">T1_data</span><span class="p">)</span>

<span class="n">est</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
<span class="n">est</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ipopt 3.13.2: 

******************************************************************************
This program contains Ipopt, a library for large-scale nonlinear optimization.
 Ipopt is released as open source code under the Eclipse Public License (EPL).
         For more information visit http://projects.coin-or.org/Ipopt

This version of Ipopt was compiled from source code available at
    https://github.com/IDAES/Ipopt as part of the Institute for the Design of
    Advanced Energy Systems Process Systems Engineering Framework (IDAES PSE
    Framework) Copyright (c) 2018-2019. See https://github.com/IDAES/idaes-pse.

This version of Ipopt was compiled using HSL, a collection of Fortran codes
    for large-scale scientific computation.  All technical papers, sales and
    publicity material resulting from use of the HSL codes within IPOPT must
    contain the following acknowledgement:
        HSL, a collection of Fortran codes for large-scale scientific
        computation. See http://www.hsl.rl.ac.uk.
******************************************************************************

This is Ipopt version 3.13.2, running with linear solver ma27.

Number of nonzeros in equality constraint Jacobian...:     6683
Number of nonzeros in inequality constraint Jacobian.:        0
Number of nonzeros in Lagrangian Hessian.............:     3147

Total number of variables............................:     1578
                     variables with only lower bounds:        0
                variables with lower and upper bounds:      790
                     variables with only upper bounds:        0
Total number of equality constraints.................:     1574
Total number of inequality constraints...............:        0
        inequality constraints with only lower bounds:        0
   inequality constraints with lower and upper bounds:        0
        inequality constraints with only upper bounds:        0

iter    objective    inf_pr   inf_du lg(mu)  ||d||  lg(rg) alpha_du alpha_pr  ls
   0  2.9469014e+03 5.75e-01 7.97e+00  -1.0 0.00e+00    -  0.00e+00 0.00e+00   0
   1  1.9770165e+03 4.57e-01 1.81e+01  -1.0 1.09e+01    -  5.53e-01 1.81e-01f  1
   2  1.3180577e+02 1.17e-01 8.21e+03  -1.0 6.25e+00    -  3.75e-02 1.00e+00f  1
   3  2.4111490e+01 2.35e-02 1.16e+03  -1.0 1.75e+00    -  9.45e-01 1.00e+00f  1
   4  1.7643350e+01 7.08e-03 3.33e+02  -1.0 9.23e-01    -  9.94e-01 1.00e+00f  1
   5  1.7861371e+01 6.33e-04 1.42e+01  -1.0 1.60e-01    -  1.00e+00 1.00e+00h  1
   6  1.7861425e+01 3.33e-03 1.25e+01  -1.0 1.19e+01    -  1.00e+00 1.25e-01h  4
   7  1.7861286e+01 4.02e-03 1.18e+01  -1.0 1.43e+01    -  1.00e+00 5.06e-02h  5
   8  1.7861177e+01 4.78e-03 1.12e+01  -1.0 1.27e+01    -  1.00e+00 5.34e-02h  5
   9  1.7861060e+01 4.99e-03 1.10e+01  -1.0 1.55e+01    -  8.93e-01 2.05e-02h  6
iter    objective    inf_pr   inf_du lg(mu)  ||d||  lg(rg) alpha_du alpha_pr  ls
  10  1.7860924e+01 5.24e-03 1.07e+01  -1.0 1.65e+01    -  1.00e+00 1.87e-02h  6
  11  1.7866691e+01 7.82e-02 2.46e+00  -1.0 4.34e+00    -  1.00e+00 1.00e+00h  1
  12  1.7867325e+01 7.89e-02 4.45e+00  -1.0 2.77e+00  -2.0 7.45e-01 4.26e-02h  4
  13  1.7867310e+01 8.26e-02 3.11e+02  -1.0 7.79e+01  -2.5 6.19e-01 1.70e-03h  4
  14  1.7877787e+01 6.44e-03 7.31e+01  -1.0 1.87e+00    -  7.58e-01 1.00e+00h  1
  15  1.7872608e+01 2.32e-04 2.04e-01  -1.0 2.23e-01    -  1.00e+00 1.00e+00h  1
  16  1.7871254e+01 1.86e-03 1.63e-01  -1.7 1.22e-01    -  1.00e+00 1.00e+00h  1
  17  1.7871237e+01 8.25e-03 1.37e-01  -2.5 4.37e-01    -  8.81e-01 5.00e-01h  2
  18  1.7871267e+01 6.75e-04 2.03e-02  -2.5 9.07e-02  -3.0 1.00e+00 1.00e+00h  1
  19  1.7871221e+01 2.22e-06 4.93e-04  -3.8 6.11e-03  -3.4 1.00e+00 1.00e+00h  1
iter    objective    inf_pr   inf_du lg(mu)  ||d||  lg(rg) alpha_du alpha_pr  ls
  20  1.7871220e+01 1.39e-04 8.66e-04  -5.7 3.40e-02    -  9.89e-01 1.00e+00h  1
  21  1.7871220e+01 6.37e-03 3.93e-02  -5.7 2.37e-01    -  1.00e+00 1.00e+00h  1
  22  1.7871221e+01 4.02e-05 2.63e-04  -5.7 4.71e-02  -3.9 1.00e+00 1.00e+00h  1
  23  1.7871220e+01 3.73e-05 2.30e-04  -5.7 2.12e-02    -  1.00e+00 1.00e+00h  1
  24  1.7871220e+01 2.34e-03 1.43e-02  -5.7 1.35e+00    -  1.00e+00 1.25e-01h  4
  25  1.7871220e+01 2.11e-06 1.39e-05  -5.7 1.73e-02  -4.4 1.00e+00 1.00e+00h  1
  26  1.7871220e+01 2.77e-09 1.70e-08  -8.6 2.08e-04    -  1.00e+00 1.00e+00h  1
  27  1.7871220e+01 1.73e-03 1.06e-02  -9.0 6.41e-01    -  1.00e+00 2.50e-01h  3
  28  1.7871220e+01 1.73e-03 1.06e-02  -9.0 1.24e-02  -4.9 1.00e+00 4.88e-04h 12
  29  1.7871220e+01 1.73e-03 1.06e-02  -9.0 1.24e-02  -5.3 1.00e+00 3.05e-05h 16
iter    objective    inf_pr   inf_du lg(mu)  ||d||  lg(rg) alpha_du alpha_pr  ls
  30  1.7871220e+01 1.73e-03 1.06e-02  -9.0 1.23e-02  -5.8 1.00e+00 1.53e-05h 17
  31  1.7871220e+01 1.73e-03 1.06e-02  -9.0 1.22e-02  -6.3 1.00e+00 1.53e-05h 17
  32  1.7871220e+01 5.64e-07 3.40e-06  -9.0 1.19e-02  -6.8 1.00e+00 1.00e+00s 22
  33  1.7871220e+01 3.35e-05 4.07e-03  -9.0 2.40e-02    -  1.00e+00 0.00e+00S 22
  34  1.7871220e+01 7.74e-10 2.95e-07  -9.0 2.90e-04  -6.3 1.00e+00 1.00e+00h  1
  35  1.7871220e+01 2.98e-01 1.71e+00  -9.0 4.91e-01    -  3.82e-05 4.36e-05H  1
  36r 1.7871220e+01 2.98e-01 9.99e+02  -0.5 0.00e+00  -1.4 0.00e+00 1.49e-08R 27
  37r 1.1446332e+02 1.93e-01 1.50e+05  -0.5 2.43e+07    -  9.03e-06 8.16e-08f  1
  38r 9.8880324e+01 1.90e-01 7.25e+04  -0.5 3.94e+02    -  1.00e+00 8.18e-04f  1
  39r 3.2757626e+03 6.49e-01 4.91e+04  -0.5 1.45e+01    -  3.20e-01 8.35e-01f  1
iter    objective    inf_pr   inf_du lg(mu)  ||d||  lg(rg) alpha_du alpha_pr  ls
  40r 4.4216337e+03 4.38e-01 4.47e+03  -0.5 3.25e+01    -  1.00e+00 5.14e-01f  1
  41r 4.3885002e+03 4.38e-01 4.47e+03  -0.5 4.90e+03  -4.0 1.02e-04 1.02e-04s  9
  42r 6.4663889e+04 2.20e-01 1.54e+04  -0.5 4.70e+01    -  4.73e-01 0.00e+00S  9
  43r 1.7907069e+04 2.61e-02 4.16e+04  -0.5 2.12e+01    -  9.45e-01 8.78e-01f  1
  44r 5.3466951e+03 6.63e-02 1.65e+02  -0.5 1.15e+01    -  7.65e-01 1.00e+00f  1
  45r 2.1030922e+03 2.24e-01 4.11e+03  -0.5 1.03e+01    -  1.00e+00 1.00e+00f  1
  46r 9.6240537e+02 3.48e-02 6.71e+03  -0.5 5.97e+00    -  1.00e+00 1.00e+00f  1
  47r 1.7853713e+02 2.45e-02 1.04e+03  -0.5 2.39e+00    -  1.00e+00 1.00e+00f  1
  48r 4.3801804e+01 2.07e-02 2.01e+02  -0.5 1.34e+00    -  1.00e+00 1.00e+00f  1
  49r 4.4909962e+01 2.14e-02 4.11e+01  -0.5 1.38e+00    -  1.00e+00 1.00e+00h  1
iter    objective    inf_pr   inf_du lg(mu)  ||d||  lg(rg) alpha_du alpha_pr  ls
  50r 4.7575351e+01 7.90e-03 4.88e+00  -0.5 6.58e-01    -  1.00e+00 1.00e+00h  1
  51r 2.0926890e+01 6.25e-04 1.09e+00  -1.2 4.90e-01    -  1.00e+00 1.00e+00f  1
  52r 1.9362264e+01 3.26e-05 4.67e-02  -1.9 8.20e-02    -  1.00e+00 1.00e+00f  1
  53r 1.8697671e+01 2.04e-05 6.55e-03  -4.3 5.90e-02    -  1.00e+00 1.00e+00f  1
  54r 1.8752986e+01 2.61e-07 8.32e-04  -4.3 6.62e-03    -  1.00e+00 1.00e+00h  1
  55r 1.8690833e+01 3.22e-07 8.83e-05  -6.5 7.78e-03    -  1.00e+00 1.00e+00f  1
  56r 1.8695336e+01 1.99e-09 4.81e-06  -6.5 5.94e-04    -  1.00e+00 1.00e+00h  1
  57r 1.8690431e+01 2.37e-09 7.54e-06  -9.0 6.52e-04    -  1.00e+00 1.00e+00f  1
  58r 1.8690670e+01 5.51e-12 2.14e-08  -9.0 3.19e-05    -  1.00e+00 1.00e+00h  1
  59  1.7850034e+01 2.79e-04 1.11e+02  -9.0 1.96e-01    -  1.00e+00 1.00e+00f  1
iter    objective    inf_pr   inf_du lg(mu)  ||d||  lg(rg) alpha_du alpha_pr  ls
  60  1.7871168e+01 2.99e-07 4.95e-02  -9.0 4.59e-03    -  1.00e+00 1.00e+00h  1
  61  1.7871220e+01 1.06e-13 6.64e-08  -9.0 4.57e-06  -1.9 1.00e+00 1.00e+00h  1
  62  1.7871220e+01 1.33e-09 7.86e-09  -9.0 3.07e-04    -  1.00e+00 1.00e+00h  1

Number of Iterations....: 62

                                   (scaled)                 (unscaled)
Objective...............:   1.7871220138760215e+01    1.7871220138760215e+01
Dual infeasibility......:   7.8557575532352264e-09    7.8557575532352264e-09
Constraint violation....:   1.3279505828300842e-09    1.3279505828300842e-09
Complementarity.........:   9.0909090909090931e-10    9.0909090909090931e-10
Overall NLP error.......:   7.8557575532352264e-09    7.8557575532352264e-09


Number of objective function evaluations             = 223
Number of objective gradient evaluations             = 42
Number of equality constraint evaluations            = 223
Number of inequality constraint evaluations          = 0
Number of equality constraint Jacobian evaluations   = 64
Number of inequality constraint Jacobian evaluations = 0
Number of Lagrangian Hessian evaluations             = 62
Total CPU secs in IPOPT (w/o function evaluations)   =      0.200
Total CPU secs in NLP function evaluations           =      0.021

EXIT: Optimal Solution Found.
</pre></div>
</div>
<img alt="../../_images/eb0786c3a15a3cfb05e8f8eaa4dcf8679b59368f7b3101e7ef255e62087648c8.png" src="../../_images/eb0786c3a15a3cfb05e8f8eaa4dcf8679b59368f7b3101e7ef255e62087648c8.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">est</span><span class="o">.</span><span class="n">print_parameters</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The value of Ua is 0.0538 Watts/degC.
The value of Ub is 0.0097 Watts/degC.
The value of CpH is 7.104 Joules/degC.
The value of CpS is 0.222 Joules/degC.
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="recommended-exercise-take-two">
<h2><span class="section-number">6.8.7. </span>Recommended Exercise: Take Two<a class="headerlink" href="#recommended-exercise-take-two" title="Link to this heading">#</a></h2>
<p>How can we make our strategy better? One idea is to perform the optimization again using the estimated parameters. We can see there was some plant-model mismatch, which caused our open-loop optimization to only perform okay.</p>
<section id="open-loop-optimization">
<h3><span class="section-number">6.8.7.1. </span>Open-Loop Optimization<a class="headerlink" href="#open-loop-optimization" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Ua_new</span><span class="p">,</span> <span class="n">Ub_new</span><span class="p">,</span> <span class="n">CpH_new</span><span class="p">,</span> <span class="n">CpS_new</span> <span class="o">=</span> <span class="n">est</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">()</span>

<span class="n">opt2</span> <span class="o">=</span> <span class="n">TCLabPyomo</span><span class="p">(</span><span class="s1">&#39;optimize&#39;</span><span class="p">,</span>
                 <span class="n">t_sim</span><span class="p">,</span>
                 <span class="n">u_sim</span><span class="p">,</span>
                 <span class="n">d_sim</span><span class="p">,</span>
                 <span class="n">setpoint_sim</span><span class="p">,</span>
                 <span class="kc">None</span><span class="p">,</span>
                 <span class="n">obj_weight</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                 <span class="n">Ua</span><span class="o">=</span><span class="n">Ua_new</span><span class="p">,</span>
                 <span class="n">Ub</span><span class="o">=</span><span class="n">Ub_new</span><span class="p">,</span>
                 <span class="n">CpH</span><span class="o">=</span><span class="n">CpH_new</span><span class="p">,</span>
                 <span class="n">CpS</span><span class="o">=</span><span class="n">CpS_new</span>
<span class="p">)</span>

<span class="n">opt2</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
<span class="n">opt2</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ipopt 3.13.2: 

******************************************************************************
This program contains Ipopt, a library for large-scale nonlinear optimization.
 Ipopt is released as open source code under the Eclipse Public License (EPL).
         For more information visit http://projects.coin-or.org/Ipopt

This version of Ipopt was compiled from source code available at
    https://github.com/IDAES/Ipopt as part of the Institute for the Design of
    Advanced Energy Systems Process Systems Engineering Framework (IDAES PSE
    Framework) Copyright (c) 2018-2019. See https://github.com/IDAES/idaes-pse.

This version of Ipopt was compiled using HSL, a collection of Fortran codes
    for large-scale scientific computation.  All technical papers, sales and
    publicity material resulting from use of the HSL codes within IPOPT must
    contain the following acknowledgement:
        HSL, a collection of Fortran codes for large-scale scientific
        computation. See http://www.hsl.rl.ac.uk.
******************************************************************************

This is Ipopt version 3.13.2, running with linear solver ma27.

Number of nonzeros in equality constraint Jacobian...:     2601
Number of nonzeros in inequality constraint Jacobian.:        0
Number of nonzeros in Lagrangian Hessian.............:      400

Total number of variables............................:     1003
                     variables with only lower bounds:        0
                variables with lower and upper bounds:      601
                     variables with only upper bounds:        0
Total number of equality constraints.................:      802
Total number of inequality constraints...............:        0
        inequality constraints with only lower bounds:        0
   inequality constraints with lower and upper bounds:        0
        inequality constraints with only upper bounds:        0

iter    objective    inf_pr   inf_du lg(mu)  ||d||  lg(rg) alpha_du alpha_pr  ls
   0  4.7760162e+04 3.43e-01 7.80e+01  -1.0 0.00e+00    -  0.00e+00 0.00e+00   0
   1  1.7095668e+05 2.11e-15 4.49e+01  -1.0 4.06e+01    -  2.11e-02 1.00e+00h  1
   2  5.9231199e+04 2.11e-15 2.05e+01  -1.0 1.59e+02    -  3.73e-03 6.19e-01f  1
   3  1.2794706e+04 3.01e-15 7.77e+00  -1.0 1.01e+02    -  1.43e-01 6.34e-01f  1
   4  3.5817048e+03 2.11e-15 3.72e+00  -1.0 5.54e+01    -  2.18e-01 5.60e-01f  1
   5  1.0237398e+03 2.80e-15 1.48e+00  -1.0 3.25e+01    -  2.76e-01 6.89e-01f  1
   6  5.7367406e+02 2.35e-15 3.50e-01  -1.0 2.55e+01    -  3.45e-01 9.62e-01f  1
   7  5.3846240e+02 2.12e-15 2.31e-01  -1.0 1.88e+01    -  4.34e-01 9.11e-01f  1
   8  5.2373755e+02 2.47e-15 1.25e-01  -1.0 1.79e+01    -  5.16e-01 8.74e-01f  1
   9  5.1498417e+02 2.65e-15 5.57e-02  -1.0 2.39e+01    -  6.14e-01 1.00e+00f  1
iter    objective    inf_pr   inf_du lg(mu)  ||d||  lg(rg) alpha_du alpha_pr  ls
  10  5.1024051e+02 2.24e-15 1.21e-02  -1.0 1.95e+01    -  8.16e-01 1.00e+00f  1
  11  5.0677769e+02 2.55e-15 5.77e-03  -1.7 1.88e+01    -  8.11e-01 5.57e-01f  1
  12  5.0384725e+02 2.30e-15 2.94e-03  -1.7 3.04e+01    -  8.43e-01 9.56e-01f  1
  13  5.0268139e+02 2.61e-15 3.74e-04  -2.5 1.29e+01    -  8.95e-01 8.39e-01f  1
  14  5.0221299e+02 2.16e-15 2.09e-03  -3.8 1.14e+01    -  7.46e-01 9.76e-01f  1
  15  5.0217210e+02 2.39e-15 1.41e-03  -3.8 6.98e+00    -  7.61e-01 1.00e+00f  1
  16  5.0216621e+02 2.05e-15 1.26e-14  -3.8 8.53e+00    -  1.00e+00 1.00e+00f  1
  17  5.0215518e+02 2.41e-15 9.61e-05  -5.7 2.39e+00    -  9.26e-01 9.95e-01f  1
  18  5.0215494e+02 2.78e-15 1.35e-14  -5.7 2.76e+00    -  1.00e+00 1.00e+00f  1
  19  5.0215493e+02 2.65e-15 1.29e-14  -5.7 1.66e+01    -  1.00e+00 1.00e+00f  1
iter    objective    inf_pr   inf_du lg(mu)  ||d||  lg(rg) alpha_du alpha_pr  ls
  20  5.0215481e+02 2.41e-15 1.75e-07  -8.6 1.50e-01    -  9.96e-01 1.00e+00f  1
  21  5.0215481e+02 2.11e-15 1.16e-14  -8.6 1.36e-02    -  1.00e+00 1.00e+00h  1

Number of Iterations....: 21

                                   (scaled)                 (unscaled)
Objective...............:   5.0215480619943486e+02    5.0215480619943486e+02
Dual infeasibility......:   1.1649539495231926e-14    1.1649539495231926e-14
Constraint violation....:   2.1094237467877974e-15    2.1094237467877974e-15
Complementarity.........:   6.0717696217608107e-09    6.0717696217608107e-09
Overall NLP error.......:   6.0717696217608107e-09    6.0717696217608107e-09


Number of objective function evaluations             = 22
Number of objective gradient evaluations             = 22
Number of equality constraint evaluations            = 22
Number of inequality constraint evaluations          = 0
Number of equality constraint Jacobian evaluations   = 22
Number of inequality constraint Jacobian evaluations = 0
Number of Lagrangian Hessian evaluations             = 21
Total CPU secs in IPOPT (w/o function evaluations)   =      0.014
Total CPU secs in NLP function evaluations           =      0.001

EXIT: Optimal Solution Found.
</pre></div>
</div>
<img alt="../../_images/0c8cc943b08b8760eb881bb6ab800c5b51aabb0c8855f8f49123cabcaf99d177.png" src="../../_images/0c8cc943b08b8760eb881bb6ab800c5b51aabb0c8855f8f49123cabcaf99d177.png" />
</div>
</div>
</section>
<section id="implement-on-hardware-simulation">
<h3><span class="section-number">6.8.7.2. </span>Implement on Hardware (Simulation)<a class="headerlink" href="#implement-on-hardware-simulation" title="Link to this heading">#</a></h3>
<p>Again, we will NOT apply the disturbance. Thus we expect to see some discrepency starting at 300 seconds. We planned for the disturbance but it did not happen.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">h2</span> <span class="o">=</span> <span class="n">perform_hardware_simulation</span><span class="p">(</span><span class="n">opt2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/18b84376a12db8e820b27fedf695df021a135c09ae23be1ef47fd16a4c7eaaf7.png" src="../../_images/18b84376a12db8e820b27fedf695df021a135c09ae23be1ef47fd16a4c7eaaf7.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>TCLab Model disconnected successfully.
</pre></div>
</div>
</div>
</div>
<p>The updated parameters cause the model prediction to match the hardware (simulation) data until a little after 300 seconds. Recall we planned for a distrubrance starting at 300 seconds, but did not include the distrubance in our simulation.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/6"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="time-as-decision-variable.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">6.7. </span>Time as a Decision Variable</p>
      </div>
    </a>
    <a class="right-next"
       href="TCLab-Model-Predictive-Control.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">6.9. </span>TCLab: Model Predictive Control (MPC)</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-objectives">6.8.1. Learning Objectives</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mathematical-model-and-pyomo-simulation">6.8.2. Mathematical Model and Pyomo Simulation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pyomo-model">6.8.2.1. Pyomo Model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#process-inputs">6.8.2.2. Process Inputs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#optimal-control-with-knowledge-of-disturbances">6.8.3. Optimal Control with Knowledge of Disturbances</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#hardware-implementation">6.8.4. Hardware Implementation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#estimation-observation">6.8.5. Estimation/Observation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#small-objective-weight-w-0-01">6.8.5.1. Small Objective Weight (<span class="math notranslate nohighlight">\(w=0.01\)</span>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#medium-objective-weight-w-0-1">6.8.5.2. Medium Objective Weight (<span class="math notranslate nohighlight">\(w=0.1\)</span>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#medium-large-objective-weight-w-1">6.8.5.3. Medium Large Objective Weight (<span class="math notranslate nohighlight">\(w=1\)</span>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extra-large-objective-weight-w-10">6.8.5.4. Extra Large Objective Weight (<span class="math notranslate nohighlight">\(w=10\)</span>)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#parameter-estimation">6.8.6. Parameter Estimation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assume-no-disturbance">6.8.6.1. Assume no disturbance</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recommended-exercise-take-two">6.8.7. Recommended Exercise: Take Two</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#open-loop-optimization">6.8.7.1. Open-Loop Optimization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implement-on-hardware-simulation">6.8.7.2. Implement on Hardware (Simulation)</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Jeffrey Kantor, Alexander Dowling, and Jeremiah Zartman
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
       Copyright 2026, Jeffrey Kantor, Alexander Dowling, and Jeremiah Zartman.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>